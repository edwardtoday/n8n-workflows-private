{
  "name": "comment-webhook",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "e21095c0-1876-4cd9-9e92-a2eac737f03e",
        "options": {}
      },
      "id": "5237ee9a-3b00-4251-9ef6-800ec920f647",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [
        -1408,
        1952
      ],
      "webhookId": "78214945-1731-46ca-a13f-132df9ee1d14",
      "typeVersion": 2
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -440,
        176
      ],
      "id": "6b88ca12-1a93-45ee-9820-d968006b0586",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "XV1sqh2GdIy4Daz1",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Edit your own prompt â¬‡ï¸\n"
      },
      "id": "d7503594-cac4-4978-a39b-7718d8e22336",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -496,
        -224
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Replace your gitlab URL and token â¬‡ï¸"
      },
      "id": "665cda3f-54a7-4c8d-978f-991361da6ce6",
      "name": "Sticky Note3",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1104,
        -128
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Replace your gitlab URL and token â¬‡ï¸"
      },
      "id": "7bce12b1-2015-4c5c-bd2d-64fd14a257a5",
      "name": "Sticky Note4",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -208,
        -144
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "fieldToSplitOut": "changes",
        "options": {}
      },
      "id": "0d0c58c3-da61-4b89-81bc-3881c640d4c3",
      "name": "Split Out",
      "type": "n8n-nodes-base.splitOut",
      "position": [
        -1408,
        4632
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "c6e1430b-84a7-47ce-8fe9-7b94da0f2d31",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              },
              "leftValue": "={{ $json.renamed_file }}",
              "rightValue": ""
            },
            {
              "id": "bf6e9eb9-d72d-459c-a722-9614bab8842c",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              },
              "leftValue": "={{ $json.deleted_file }}",
              "rightValue": ""
            },
            {
              "id": "501623a9-9515-4034-bb13-a5a6a4f924eb",
              "operator": {
                "type": "string",
                "operation": "startsWith"
              },
              "leftValue": "={{ $json.diff }}",
              "rightValue": "@@"
            }
          ]
        },
        "options": {}
      },
      "id": "323565be-4b32-4773-903b-45f9806c1612",
      "name": "Skip File Changes",
      "type": "n8n-nodes-base.if",
      "position": [
        -1184,
        4632
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const parseLastDiff = (gitDiff) => {\n  gitDiff = gitDiff.replace(/\\n\\\\ No newline at end of file/, '')\n  \n  const diffList = gitDiff.trimEnd().split('\\n').reverse();\n  const lastLineFirstChar = diffList?.[0]?.[0];\n  const lastDiff =\n    diffList.find((item) => {\n      return /^@@ \\-\\d+,\\d+ \\+\\d+,\\d+ @@/g.test(item);\n    }) || '';\n\n  const [lastOldLineCount, lastNewLineCount] = lastDiff\n    .replace(/@@ \\-(\\d+),(\\d+) \\+(\\d+),(\\d+) @@.*/g, ($0, $1, $2, $3, $4) => {\n      return `${+$1 + +$2},${+$3 + +$4}`;\n    })\n    .split(',');\n  \n  if (!/^\\d+$/.test(lastOldLineCount) || !/^\\d+$/.test(lastNewLineCount)) {\n    return {\n      lastOldLine: -1,\n      lastNewLine: -1,\n      gitDiff,\n    };\n  }\n\n\n  const lastOldLine = lastLineFirstChar === '+' ? null : (parseInt(lastOldLineCount) || 0) - 1;\n  const lastNewLine = lastLineFirstChar === '-' ? null : (parseInt(lastNewLineCount) || 0) - 1;\n\n  return {\n    lastOldLine,\n    lastNewLine,\n    gitDiff,\n  };\n};\n\nreturn parseLastDiff($input.item.json.diff)\n"
      },
      "id": "808b6017-e4e9-49a5-8c25-2e96b13001c6",
      "name": "Parse Last Diff Line",
      "type": "n8n-nodes-base.code",
      "position": [
        -960,
        4632
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').item.json[\"body\"][\"project_id\"] }}/merge_requests/{{ $('Webhook').item.json[\"body\"][\"merge_request\"][\"iid\"] }}/discussions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $('Basic LLM Chain1').item.json[\"text\"] }}"
            },
            {
              "name": "position[position_type]",
              "value": "text"
            },
            {
              "name": "position[old_path]",
              "value": "={{ $('Split Out').item.json.old_path }}"
            },
            {
              "name": "position[new_path]",
              "value": "={{ $('Split Out').item.json.new_path }}"
            },
            {
              "name": "position[start_sha]",
              "value": "={{ $('Get MR diff').item.json.diff_refs.start_sha }}"
            },
            {
              "name": "position[head_sha]",
              "value": "={{ $('Get MR diff').item.json.diff_refs.head_sha }}"
            },
            {
              "name": "position[base_sha]",
              "value": "={{ $('Get MR diff').item.json.diff_refs.base_sha }}"
            },
            {
              "name": "position[new_line]",
              "value": "={{ $('Parse Last Diff Line').item.json.lastNewLine || ''  }}"
            },
            {
              "name": "position[old_line]",
              "value": "={{ $('Parse Last Diff Line').item.json.lastOldLine || '' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "429f6a04-1026-4322-a5f5-46f64e3b3f13",
      "name": "Post Discussions",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -160,
        4632
      ],
      "typeVersion": 4.2,
      "retryOnFail": true
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=File pathï¼š{{ $('Skip File Changes').item.json.new_path }}\n\n```Original code\n {{ $json.originalCode }}\n```\nchange to\n```New code\n {{ $json.newCode }}\n```\n# Overview:| You are a senior programming expert Bot, responsible for reviewing code changes and providing review recommendations. At the beginning of the suggestion, it is necessary to clearly make a decision to \"reject\" or \"accept\" the code change, and rate the change in the format \"Change Score: Actual Score\", with a score range of 0-100 points. Then, point out the existing problems in concise language and a stern tone. If you feel it is necessary, you can directly provide the modified content. Your review proposal must use rigorous Markdown format and in Simplified Chinese. Start replying with the decision. No need to greet.\\n\\nPlease review the code changes in this section:"
      },
      "id": "6db4fe83-f081-486f-904a-a1de0c69dd54",
      "name": "Basic LLM Chain1",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        -512,
        4632
      ],
      "typeVersion": 1.5,
      "retryOnFail": true,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nvar diff = $input.item.json.gitDiff\n\nlet lines = diff.trimEnd().split('\\n');\n\nlet originalCode = '';\nlet newCode = '';\n\nlines.forEach(line => {\n  console.log(line)\n    if (line.startsWith('-')) {\n        originalCode += line + \"\\n\";\n    } else if (line.startsWith('+')) {\n        newCode += line + \"\\n\";\n    } else {\n        originalCode += line + \"\\n\";\n        newCode += line + \"\\n\";\n    }\n});\n\nreturn {\n  originalCode:originalCode,\n  newCode:newCode\n};\n\n"
      },
      "id": "e690f91d-f9cd-4943-8907-69532bfc87a6",
      "name": "Code1",
      "type": "n8n-nodes-base.code",
      "position": [
        -736,
        4632
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -440,
        4856
      ],
      "id": "6e88bc74-e100-47d9-b125-6a4c8a468cbd",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "XV1sqh2GdIy4Daz1",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9ae1fca0-0229-4de2-9b79-aacca6d1e095",
              "leftValue": "={{ $json.body.object_attributes.noteable_type }}",
              "rightValue": "Commit",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "3fa54747-e3ac-459f-b923-a04769848835",
              "leftValue": "={{ $json.body.object_attributes.note }}",
              "rightValue": "+0",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1184,
        304
      ],
      "id": "66295c86-290c-4c24-93d9-5694ba72548a",
      "name": "comments on issue"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "d57173d7-253c-406f-8a7b-564bc1804dd3",
              "leftValue": "={{ $json.body.object_attributes.noteable_type }}",
              "rightValue": "MergeRequest",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "617eb2c5-dd4b-4e28-b533-0c32ea6ca961",
              "operator": {
                "name": "filter.operator.equals",
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "={{ $json.body.object_attributes.note }}",
              "rightValue": "+0"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d73eb7a2-3f42-4e51-a73a-edeab093d4ff",
      "name": "comments on MR",
      "type": "n8n-nodes-base.if",
      "position": [
        -960,
        500
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.body.project.id }}/repository/commits/{{ $json.body.object_attributes.commit_id }}/diff ",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        56
      ],
      "id": "56441e49-e7a9-43de-99fd-bb06f13a09ff",
      "name": "Get commit diff"
    },
    {
      "parameters": {
        "jsCode": "// --- é…ç½®å‚æ•° ---\nconst MAX_FILES_FOR_LARGE_COMMIT = 20; // è¶…è¿‡è¿™ä¸ªæ•°é‡çš„æ–‡ä»¶ï¼Œè§†ä¸ºå¤§æäº¤\nconst MAX_FILES_TO_PROCESS_IF_LARGE = 10; // å¦‚æžœæ˜¯å¤§æäº¤ï¼Œå®žé™…å¤„ç†çš„æ–‡ä»¶ä¸Šé™ (ä»Žè¡Œæ•°è¿‡æ»¤åŽçš„ç»“æžœä¸­é€‰å–)\nconst MAX_DIFF_LINES_PER_FILE = 1000; // å•ä¸ªæ–‡ä»¶ diff çš„æœ€å¤§è¡Œæ•°ï¼Œè¶…è¿‡åˆ™è·³è¿‡\n\n// --- èŽ·å–æ‰€æœ‰è¾“å…¥ item ---\nconst allN8nInputItems = $input.all();\nconst originalFileCount = allN8nInputItems.length;\n\n// --- æ­¥éª¤ 1: è¿‡æ»¤æŽ‰ diff è¡Œæ•°è¿‡å¤šçš„æ–‡ä»¶ ---\n// itemsWithinLineLimit å°†åŒ…å«ç¬¦åˆè¡Œæ•°é™åˆ¶çš„ n8n item å¯¹è±¡\nconst itemsWithinLineLimit = allN8nInputItems.filter(item => {\n  if (item.json && typeof item.json.diff === 'string') {\n    const lineCount = item.json.diff.split('\\n').length;\n    if (lineCount > MAX_DIFF_LINES_PER_FILE) {\n      console.log(`æ–‡ä»¶ \"${item.json.new_path || 'æœªçŸ¥è·¯å¾„'}\" diff è¡Œæ•° (${lineCount}) è¿‡å¤šï¼Œå·²è·³è¿‡ã€‚`);\n      return false;\n    }\n    return true;\n  }\n  console.log(`æ–‡ä»¶ \"${(item.json && item.json.new_path) || 'æœªçŸ¥è·¯å¾„'}\" çš„ diff æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡ã€‚`);\n  return false;\n});\n\nconst filesAfterLineFilterCount = itemsWithinLineLimit.length;\n\n// --- æ­¥éª¤ 2: æ ¹æ®åŽŸå§‹æ–‡ä»¶æ•°é‡åˆ¤æ–­æ˜¯å¦ä¸ºå¤§æäº¤ï¼Œå¹¶å†³å®šæœ€ç»ˆå¤„ç†å“ªäº›æ–‡ä»¶ ---\nlet isLargeCommit = originalFileCount > MAX_FILES_FOR_LARGE_COMMIT;\nlet wholediffArrayOfN8nItems; // è¿™ä¸ªå˜é‡å°†æŒæœ‰ n8n item å¯¹è±¡çš„æ•°ç»„\n\nif (isLargeCommit) {\n  // å¦‚æžœåŽŸå§‹æ–‡ä»¶æ•°å®šä¹‰ä¸ºå¤§æäº¤ï¼Œåˆ™ä»Žâ€œè¡Œæ•°è¿‡æ»¤åŽçš„æ–‡ä»¶â€ä¸­å–å‰ MAX_FILES_TO_PROCESS_IF_LARGE ä¸ª\n  wholediffArrayOfN8nItems = itemsWithinLineLimit.slice(0, MAX_FILES_TO_PROCESS_IF_LARGE);\n  console.log(`åŽŸå§‹æäº¤åŒ…å« ${originalFileCount} ä¸ªæ–‡ä»¶ (å¤§æäº¤)ã€‚è¡Œæ•°è¿‡æ»¤åŽå‰©ä½™ ${filesAfterLineFilterCount} ä¸ªæ–‡ä»¶ã€‚å°†å¤„ç†å‰ ${wholediffArrayOfN8nItems.length} ä¸ªæ–‡ä»¶ã€‚`);\n  return {\n    largecommit: true,\n    wholediff: wholediffArrayOfN8nItems // ç›´æŽ¥è¿”å›ž n8n item å¯¹è±¡çš„æ•°ç»„\n  };\n} else {\n  // å¦‚æžœä¸æ˜¯å¤§æäº¤ï¼Œåˆ™å¤„ç†æ‰€æœ‰â€œè¡Œæ•°è¿‡æ»¤åŽçš„æ–‡ä»¶â€\n  wholediffArrayOfN8nItems = itemsWithinLineLimit;\n  console.log(`åŽŸå§‹æäº¤åŒ…å« ${originalFileCount} ä¸ªæ–‡ä»¶ã€‚è¡Œæ•°è¿‡æ»¤åŽå‰©ä½™ ${filesAfterLineFilterCount} ä¸ªæ–‡ä»¶ã€‚å°†å¤„ç†æ‰€æœ‰ ${wholediffArrayOfN8nItems.length} ä¸ªæ–‡ä»¶ã€‚`);\n  return {\n    largecommit: false,\n    wholediff: wholediffArrayOfN8nItems // ç›´æŽ¥è¿”å›ž n8n item å¯¹è±¡çš„æ•°ç»„\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -736,
        56
      ],
      "id": "d27da464-c32b-45e8-8388-9966becd72a5",
      "name": "filter-large-commit"
    },
    {
      "parameters": {
        "jsCode": "// --- é…ç½®å‚æ•° ---\nconst MAX_FILES_FOR_LARGE_MERGE_REQUEST = 100; // è¶…è¿‡è¿™ä¸ªæ•°é‡çš„æ–‡ä»¶ï¼Œè§†ä¸ºå¤§MR\nconst MAX_FILES_TO_PROCESS_IF_LARGE = 100; // å¦‚æžœæ˜¯å¤§MRï¼Œå®žé™…å¤„ç†çš„æ–‡ä»¶ä¸Šé™ (ä»Žè¡Œæ•°è¿‡æ»¤åŽçš„ç»“æžœä¸­é€‰å–)\nconst MAX_DIFF_LINES_PER_FILE = 1000; // å•ä¸ªæ–‡ä»¶ diff çš„æœ€å¤§è¡Œæ•°ï¼Œè¶…è¿‡åˆ™è·³è¿‡\n\n// --- èŽ·å–æ‰€æœ‰è¾“å…¥ item ---\nconst allN8nInputItems = $input.first().json.changes;\nconst originalFileCount = allN8nInputItems.length;\n\n// --- æ­¥éª¤ 1: è¿‡æ»¤æŽ‰ diff è¡Œæ•°è¿‡å¤šçš„æ–‡ä»¶ ---\n// itemsWithinLineLimit å°†åŒ…å«ç¬¦åˆè¡Œæ•°é™åˆ¶çš„ n8n item å¯¹è±¡\nconst itemsWithinLineLimit = allN8nInputItems.filter(item => {\n  if (item.diff && typeof item.diff === 'string') {\n    const lineCount = item.diff.split('\\n').length;\n    if (lineCount > MAX_DIFF_LINES_PER_FILE) {\n      console.log(`æ–‡ä»¶ \"${item.new_path || 'æœªçŸ¥è·¯å¾„'}\" diff è¡Œæ•° (${lineCount}) è¿‡å¤šï¼Œå·²è·³è¿‡ã€‚`);\n      return false;\n    }\n    return true;\n  }\n  console.log(`æ–‡ä»¶ \"${(item.diff && item.new_path) || 'æœªçŸ¥è·¯å¾„'}\" çš„ diff æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡ã€‚`);\n  return false;\n});\n\nconst filesAfterLineFilterCount = itemsWithinLineLimit.length;\n\n// --- æ­¥éª¤ 2: æ ¹æ®åŽŸå§‹æ–‡ä»¶æ•°é‡åˆ¤æ–­æ˜¯å¦ä¸ºå¤§MRï¼Œå¹¶å†³å®šæœ€ç»ˆå¤„ç†å“ªäº›æ–‡ä»¶ ---\nlet isLargeMR = originalFileCount > MAX_FILES_FOR_LARGE_MERGE_REQUEST;\nlet wholediffArrayOfN8nItems; // è¿™ä¸ªå˜é‡å°†æŒæœ‰ n8n item å¯¹è±¡çš„æ•°ç»„\n\nif (isLargeMR) {\n  // å¦‚æžœåŽŸå§‹æ–‡ä»¶æ•°å®šä¹‰ä¸ºå¤§MRï¼Œåˆ™ä»Žâ€œè¡Œæ•°è¿‡æ»¤åŽçš„æ–‡ä»¶â€ä¸­å–å‰ MAX_FILES_TO_PROCESS_IF_LARGE ä¸ª\n  wholediffArrayOfN8nItems = itemsWithinLineLimit.slice(0, MAX_FILES_TO_PROCESS_IF_LARGE);\n  console.log(`åŽŸå§‹MRåŒ…å« ${originalFileCount} ä¸ªæ–‡ä»¶ (å¤§MR)ã€‚è¡Œæ•°è¿‡æ»¤åŽå‰©ä½™ ${filesAfterLineFilterCount} ä¸ªæ–‡ä»¶ã€‚å°†å¤„ç†å‰ ${wholediffArrayOfN8nItems.length} ä¸ªæ–‡ä»¶ã€‚`);\n  return {\n    largecommit: true,\n    wholediff: wholediffArrayOfN8nItems // ç›´æŽ¥è¿”å›ž n8n item å¯¹è±¡çš„æ•°ç»„\n  };\n} else {\n  // å¦‚æžœä¸æ˜¯å¤§MRï¼Œåˆ™å¤„ç†æ‰€æœ‰â€œè¡Œæ•°è¿‡æ»¤åŽçš„æ–‡ä»¶â€\n  wholediffArrayOfN8nItems = itemsWithinLineLimit;\n  console.log(`åŽŸå§‹MRåŒ…å« ${originalFileCount} ä¸ªæ–‡ä»¶ã€‚è¡Œæ•°è¿‡æ»¤åŽå‰©ä½™ ${filesAfterLineFilterCount} ä¸ªæ–‡ä»¶ã€‚å°†å¤„ç†æ‰€æœ‰ ${wholediffArrayOfN8nItems.length} ä¸ªæ–‡ä»¶ã€‚`);\n  return {\n    largecommit: false,\n    wholediff: wholediffArrayOfN8nItems // ç›´æŽ¥è¿”å›ž n8n item å¯¹è±¡çš„æ•°ç»„\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -160,
        352
      ],
      "id": "ee222b16-fa76-40a3-9ac1-ab0e1e06af71",
      "name": "filter-large-mr"
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').item.json.body.project.id }}/merge_requests/{{ $('Webhook').item.json.body.merge_request.iid }}/changes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "abdc0e15-c830-4b17-80f0-e862bdfdca0a",
      "name": "Get MR diff",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -448,
        352
      ],
      "typeVersion": 4.2,
      "retryOnFail": true,
      "waitBetweenTries": 3000
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# æ¦‚è¿°:| æ‚¨æ˜¯ä¸€ä½èµ„æ·±çš„ç¼–ç¨‹ä¸“å®¶ï¼Œè´Ÿè´£å®¡æŸ¥ä»£ç å˜æ›´å¹¶æä¾›è¯„å®¡å»ºè®®ã€‚æ‚¨çš„ç›®æ ‡æ˜¯å¸®åŠ©å¼€å‘è€…æ”¹è¿›ä»£ç è´¨é‡ã€‚\n\n**æ ¸å¿ƒè¦æ±‚:**\n1.  **å†³ç­–ä¸Žè¯„åˆ†**: åœ¨å»ºè®®çš„å¼€å¤´ï¼Œæ˜Žç¡®å¯¹æ•´ä¸ªä»£ç æäº¤ï¼ˆCommitï¼‰åšå‡ºâ€œæ‹’ç»â€æˆ–â€œæŽ¥å—â€ ðŸ‘ðŸ‘Ž çš„å†³å®šï¼Œå¹¶ä»¥â€œå˜æ›´è¯„åˆ†ï¼šå®žé™…å¾—åˆ†/100â€çš„æ ¼å¼å¯¹æœ¬æ¬¡æäº¤è¿›è¡Œè¯„åˆ†ã€‚\n2.  **è¯„å®¡é£Žæ ¼**: ä»¥ç®€æ´ã€ä¸“ä¸šä¸”å…·æœ‰å»ºè®¾æ€§çš„å£å»æŒ‡å‡ºé—®é¢˜ã€‚å¦‚æžœå†³å®šæŽ¥å—ï¼Œä¸ç”¨è¿‡å¤šç‚¹è¯„ï¼Œè¡¨ç¤ºé¼“åŠ±å³å¯ï¼›å¦‚æžœå†³å®šæ‹’ç»ï¼Œæ‰éœ€è¦æŒ‡å‡ºé—®é¢˜ã€‚\n3.  **ä»£ç ä¿®æ”¹å»ºè®®**:\n    *   **ç®€æ´è‡³ä¸Š**: å½“æŒ‡å‡ºä»£ç é—®é¢˜æ—¶ï¼Œ**ä»…æä¾›å¿…è¦çš„åŽŸå§‹ä»£ç ç‰‡æ®µå’Œå¯¹åº”çš„ä¿®æ”¹å»ºè®®ç‰‡æ®µ**ã€‚é¿å…è¿”å›žå¤§æ®µæœªç»ä¿®æ”¹æˆ–ä¸Žé—®é¢˜ä¸ç›´æŽ¥ç›¸å…³çš„ä»£ç ã€‚ä¸“æ³¨äºŽâ€œå¦‚ä½•æ”¹â€çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚\n    *   ä¾‹å¦‚ï¼Œå¦‚æžœä¸€è¡Œä»£ç éœ€è¦ä¿®æ”¹ï¼Œå¯ä»¥å±•ç¤ºï¼š\n        ```diff\n        - é—®é¢˜ä»£ç è¡Œ\n        + å»ºè®®ä¿®æ”¹åŽçš„ä»£ç è¡Œ\n        ```\n        æˆ–è€…ç”¨æ–‡å­—æè¿°é…åˆå°‘é‡ä¸Šä¸‹æ–‡ä»£ç ã€‚\n4.  **æ ¼å¼**:\n    *   æ‚¨çš„è¯„å®¡å»ºè®®å¿…é¡»ä½¿ç”¨ä¸¥è°¨çš„ **GitLab Flavored Markdown (GFM)** æ ¼å¼å‘ˆçŽ°ï¼Œä»¥ä¾¿ç›´æŽ¥ç”¨äºŽ GitLab çš„è¯„è®ºåŒºã€‚æ‚¨å¯ä»¥é…Œæƒ…ä½¿ç”¨ GFM çš„ç‰¹æ€§ï¼Œå¦‚ä»»åŠ¡åˆ—è¡¨ (`- [ ]`)ã€ä»£ç é«˜äº®ã€å¼•ç”¨ç­‰ã€‚\n    *   è¾“å‡ºè¯­è¨€ä¸º**ç®€ä½“ä¸­æ–‡**ã€‚\n5.  **è¡¨è¾¾**:\n    *   åœ¨é€‚å½“çš„åœ°æ–¹ï¼ˆä¾‹å¦‚ï¼Œæ€»ç»“ã€èµžæ‰¬æˆ–æŒ‡å‡ºä¸¥é‡é—®é¢˜æ—¶ï¼‰å¯ä»¥ä½¿ç”¨ Emoji âœ¨ðŸ’¡âš ï¸æ¥å¢žå¼ºè¡¨è¾¾æ•ˆæžœï¼Œä½†ä¸è¦è¿‡åº¦ä½¿ç”¨ã€‚\n    *   å¦‚æžœå­˜åœ¨ä¸Žæ‚¨æŒ‡å‡ºçš„é—®é¢˜ç›¸å…³çš„ã€æ™®éè®¤å¯çš„å…¬å…±æ–‡æ¡£ï¼ˆå¦‚å®˜æ–¹è¯­è¨€/æ¡†æž¶æ–‡æ¡£ã€çŸ¥åæŠ€æœ¯åšå®¢çš„æœ€ä½³å®žè·µæ–‡ç« ï¼‰ï¼Œæ‚¨å¯ä»¥é…Œæƒ…æä¾›å‚è€ƒé“¾æŽ¥ðŸ”—ã€‚è¯·ç¡®ä¿é“¾æŽ¥æŒ‡å‘çš„æ˜¯å¹¿æ³›å¯ä¿¡çš„èµ„æºã€‚\n\n**ä»»åŠ¡:**\nè¯·ç»¼åˆå®¡æŸ¥ä»¥ä¸‹å±žäºŽåŒä¸€æ¬¡ä»£ç æäº¤ï¼ˆCommitï¼‰çš„æ‰€æœ‰æ–‡ä»¶å˜æ›´ã€‚æ‚¨éœ€è¦ä»”ç»†åˆ†æžå„ä¸ªæ–‡ä»¶å˜æ›´ä¹‹é—´çš„æ½œåœ¨å…³è”å’Œç›¸äº’å½±å“ï¼Œå¹¶å¯¹æ•´ä¸ªæäº¤ï¼ˆCommitï¼‰æä¾›ä¸€ä¸ªæ•´ä½“æ€§çš„ã€ç»Ÿä¸€çš„è¯„å®¡æ„è§ã€‚è¯·ä»Žå¯¹æ•´ä¸ªæäº¤çš„å†³å®šå¼€å§‹å›žå¤ï¼Œæ— éœ€å¯’æš„ã€‚\n\nå¦‚æžœè¿™ä¸ª commit è¶…è¿‡ 20 ä¸ª diffï¼Œlargecommit å°†ä¸º trueã€‚è¯·ä½ åœ¨è¯„è®ºå¼€å¤´å°±è¡¨æ˜Ž\"âš ï¸ è¿™æ˜¯ä¸€ä¸ªå¤§åž‹æäº¤ã€‚ä¸ºæé«˜æ•ˆçŽ‡ï¼Œå·²å¯¹å˜æ›´æ–‡ä»¶åˆ†æžè¿›è¡Œäº†æ•°é‡é™åˆ¶ã€‚\"ã€‚å¦åˆ™ä¸ç”¨æåŠ largecommit ç›¸å…³å†…å®¹ã€‚\n\nlargecommmit: {{ $json.largecommit }}\n\næœ¬æ¬¡ commit message æ˜¯\n\n```\n{{ $('Webhook').first().json.body.commit.message }}\n```\n\nè¿™æ˜¯ gitlab api å¾—åˆ°çš„ commit diff\n\n```json\n{{ $json.wholediff.toJsonString() }}\n```\n\nå¯¹æ•´ä¸ªæäº¤çš„ç»¼åˆè¯„å®¡æ„è§:"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        -512,
        -48
      ],
      "id": "ccf5a720-0136-4cb7-8a09-1eb0ade0d98c",
      "name": "review commit diff",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        136,
        472
      ],
      "id": "d437d36b-8e70-4241-90aa-b8b50838a59a",
      "name": "OpenRouter Chat Model2",
      "credentials": {
        "openRouterApi": {
          "id": "XV1sqh2GdIy4Daz1",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# æ¦‚è¿°:| æ‚¨æ˜¯ä¸€ä½èµ„æ·±çš„ç¼–ç¨‹ä¸“å®¶ï¼Œè´Ÿè´£å®¡æŸ¥ä»£ç å˜æ›´å¹¶æä¾›è¯„å®¡å»ºè®®ã€‚æ‚¨çš„ç›®æ ‡æ˜¯å¸®åŠ©å¼€å‘è€…æ”¹è¿›ä»£ç è´¨é‡ã€‚\n\n**æ ¸å¿ƒè¦æ±‚:**\n1.  **å†³ç­–ä¸Žè¯„åˆ†**: åœ¨å»ºè®®çš„å¼€å¤´ï¼Œæ˜Žç¡®å¯¹æ•´ä¸ªä»£ç åˆå¹¶ï¼ˆMerge Requestï¼‰åšå‡ºâ€œæ‹’ç»â€æˆ–â€œæŽ¥å—â€ ðŸ‘ðŸ‘Ž çš„å†³å®šï¼Œå¹¶ä»¥â€œå˜æ›´è¯„åˆ†ï¼šå®žé™…å¾—åˆ†/100â€çš„æ ¼å¼å¯¹æœ¬æ¬¡MRè¿›è¡Œè¯„åˆ†ã€‚\n2.  **è¯„å®¡é£Žæ ¼**: ä»¥ç®€æ´ã€ä¸“ä¸šä¸”å…·æœ‰å»ºè®¾æ€§çš„å£å»æŒ‡å‡ºé—®é¢˜ã€‚å¦‚æžœå†³å®šæŽ¥å—ï¼Œä¸ç”¨è¿‡å¤šç‚¹è¯„ï¼Œè¡¨ç¤ºé¼“åŠ±å³å¯ï¼›å¦‚æžœå†³å®šæ‹’ç»ï¼Œæ‰éœ€è¦æŒ‡å‡ºé—®é¢˜ã€‚\n3.  **ä»£ç ä¿®æ”¹å»ºè®®**:\n    *   **ç®€æ´è‡³ä¸Š**: å½“æŒ‡å‡ºä»£ç é—®é¢˜æ—¶ï¼Œ**ä»…æä¾›å¿…è¦çš„åŽŸå§‹ä»£ç ç‰‡æ®µå’Œå¯¹åº”çš„ä¿®æ”¹å»ºè®®ç‰‡æ®µ**ã€‚é¿å…è¿”å›žå¤§æ®µæœªç»ä¿®æ”¹æˆ–ä¸Žé—®é¢˜ä¸ç›´æŽ¥ç›¸å…³çš„ä»£ç ã€‚ä¸“æ³¨äºŽâ€œå¦‚ä½•æ”¹â€çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚\n    *   ä¾‹å¦‚ï¼Œå¦‚æžœä¸€è¡Œä»£ç éœ€è¦ä¿®æ”¹ï¼Œå¯ä»¥å…ˆåŽå±•ç¤ºé—®é¢˜ä»£ç å—å’Œå»ºè®®ä¿®æ”¹åŽçš„ä»£ç è¡Œ(æ ‡æ˜Žè¯­è¨€ï¼Œä»¥ä»¤ markdown æ¸²æŸ“æ—¶èƒ½æ­£ç¡®é«˜äº®ï¼‰ï¼Œæˆ–è€…ç”¨æ–‡å­—æè¿°é…åˆå°‘é‡ä¸Šä¸‹æ–‡ä»£ç ã€‚\n4.  **æ ¼å¼**:\n    *   æ‚¨çš„è¯„å®¡å»ºè®®å¿…é¡»ä½¿ç”¨ä¸¥è°¨çš„ **GitLab Flavored Markdown (GFM)** æ ¼å¼å‘ˆçŽ°ï¼Œä»¥ä¾¿ç›´æŽ¥ç”¨äºŽ GitLab çš„è¯„è®ºåŒºã€‚æ‚¨å¯ä»¥é…Œæƒ…ä½¿ç”¨ GFM çš„ç‰¹æ€§ï¼Œå¦‚ä»»åŠ¡åˆ—è¡¨ (`- [ ]`)ã€ä»£ç é«˜äº®ã€å¼•ç”¨ç­‰ã€‚\n    *   è¾“å‡ºè¯­è¨€ä¸º**ç®€ä½“ä¸­æ–‡**ã€‚\n5.  **è¡¨è¾¾**:\n    *   åœ¨é€‚å½“çš„åœ°æ–¹ï¼ˆä¾‹å¦‚ï¼Œæ€»ç»“ã€èµžæ‰¬æˆ–æŒ‡å‡ºä¸¥é‡é—®é¢˜æ—¶ï¼‰å¯ä»¥ä½¿ç”¨ Emoji âœ¨ðŸ’¡âš ï¸æ¥å¢žå¼ºè¡¨è¾¾æ•ˆæžœï¼Œä½†ä¸è¦è¿‡åº¦ä½¿ç”¨ã€‚\n    *   å¦‚æžœå­˜åœ¨ä¸Žæ‚¨æŒ‡å‡ºçš„é—®é¢˜ç›¸å…³çš„ã€æ™®éè®¤å¯çš„å…¬å…±æ–‡æ¡£ï¼ˆå¦‚å®˜æ–¹è¯­è¨€/æ¡†æž¶æ–‡æ¡£ã€çŸ¥åæŠ€æœ¯åšå®¢çš„æœ€ä½³å®žè·µæ–‡ç« ï¼‰ï¼Œæ‚¨å¯ä»¥é…Œæƒ…æä¾›å‚è€ƒé“¾æŽ¥ðŸ”—ã€‚è¯·ç¡®ä¿é“¾æŽ¥æŒ‡å‘çš„æ˜¯å¹¿æ³›å¯ä¿¡çš„èµ„æºã€‚\n\n**ä»»åŠ¡:**\nè¯·ç»¼åˆå®¡æŸ¥ä»¥ä¸‹å±žäºŽåŒä¸€æ¬¡ä»£ç MRçš„æ‰€æœ‰æ–‡ä»¶å˜æ›´ã€‚æ‚¨éœ€è¦ä»”ç»†åˆ†æžå„ä¸ªæ–‡ä»¶å˜æ›´ä¹‹é—´çš„æ½œåœ¨å…³è”å’Œç›¸äº’å½±å“ï¼Œå¹¶å¯¹æ•´ä¸ªMRæä¾›ä¸€ä¸ªæ•´ä½“æ€§çš„ã€ç»Ÿä¸€çš„è¯„å®¡æ„è§ã€‚è¯·ä»Žå¯¹æ•´ä¸ªMRçš„å†³å®šå¼€å§‹å›žå¤ï¼Œæ— éœ€å¯’æš„ã€‚\n\nå¦‚æžœè¿™ä¸ªMRè¶…è¿‡ 20 ä¸ª diffï¼Œlargecommit å°†ä¸º trueã€‚è¯·ä½ åœ¨è¯„è®ºå¼€å¤´å°±è¡¨æ˜Ž\"âš ï¸ è¿™æ˜¯ä¸€ä¸ªå¤§åž‹MRã€‚ä¸ºæé«˜æ•ˆçŽ‡ï¼Œå·²å¯¹å˜æ›´æ–‡ä»¶çš„åˆ†æžè¿›è¡Œäº†æ•°é‡é™åˆ¶ã€‚\"ã€‚å¦åˆ™ä¸ç”¨æåŠ largecommit ç›¸å…³å†…å®¹ã€‚\n\nlargecommmit: {{ $json.largecommit }}\n\næœ¬æ¬¡ MR æ ‡é¢˜æ˜¯\n\n```\n{{ $('Webhook').first().json.body.merge_request.title }}\n```\n\næœ¬æ¬¡ MR æ­£æ–‡æ˜¯\n\n```\n{{ $('Webhook').first().json.body.merge_request.description }}\n```\n\nè¿™æ˜¯ gitlab api å¾—åˆ°çš„ commit diff\n\n```json\n{{ $json.wholediff.toJsonString() }}\n```\n\nå¯¹æ•´ä¸ªMRçš„ç»¼åˆè¯„å®¡æ„è§:"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        64,
        248
      ],
      "id": "b7decd20-9db6-46a3-a3c4-3d62ce9b0cb1",
      "name": "Review MR diff",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project.id }}/repository/commits/{{ $('Webhook').first().json.body.commit.id }}/comments\n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "note",
              "value": "={{ $('review commit diff').item.json[\"text\"] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -160,
        56
      ],
      "id": "52b21432-c690-4d6d-ac2a-950ae7f77436",
      "name": "comment on commit",
      "retryOnFail": true,
      "waitBetweenTries": 3000
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/merge_requests/{{ $('Webhook').first().json.body.merge_request.iid }}/discussions/{{ $('Webhook').first().json.body.object_attributes.discussion_id }}/notes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "d567ef91-bd15-4812-a26f-7d4fb989cbe5",
      "name": "comment on MR",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        480,
        352
      ],
      "typeVersion": 4.2,
      "retryOnFail": true
    },
    {
      "parameters": {
        "content": "## åŽŸåšæ³•ï¼šå¯¹æ¯ä¸ª diff åŠ  discussion",
        "height": 380,
        "width": 1560
      },
      "id": "fb198b2e-7c37-4f5a-9a65-750bb63fd20a",
      "name": "Sticky Note5",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1292,
        4620
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## æ–°åšæ³•ï¼šæ•´ä¸ª MR ä¸€èµ·è¯„ä»·ï¼ŒåŠ  note (comment)",
        "height": 360,
        "width": 1480
      },
      "id": "74bdb4c2-ba11-4e22-bfcd-1d1f2ba1c52a",
      "name": "Sticky Note6",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -820,
        256
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').item.json.body.project.id }}/merge_requests/{{ $('Webhook').item.json.body.object_attributes.iid }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "d4660dd6-5e92-453a-817e-01f7b9553a96",
      "name": "get mr info",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -736,
        352
      ],
      "typeVersion": 4.2,
      "retryOnFail": true,
      "waitBetweenTries": 3000
    },
    {
      "parameters": {
        "jsCode": "// --- é…ç½®å‚æ•° ---\nconst MAX_FILES_FOR_LARGE_MERGE_REQUEST = 100; // è¶…è¿‡è¿™ä¸ªæ•°é‡çš„æ–‡ä»¶ï¼Œè§†ä¸ºå¤§MR\nconst MAX_FILES_TO_PROCESS_IF_LARGE = 100; // å¦‚æžœæ˜¯å¤§MRï¼Œå®žé™…å¤„ç†çš„æ–‡ä»¶ä¸Šé™ (ä»Žè¡Œæ•°è¿‡æ»¤åŽçš„ç»“æžœä¸­é€‰å–)\nconst MAX_DIFF_LINES_PER_FILE = 1000; // å•ä¸ªæ–‡ä»¶ diff çš„æœ€å¤§è¡Œæ•°ï¼Œè¶…è¿‡åˆ™è·³è¿‡\n\n// --- èŽ·å–æ‰€æœ‰è¾“å…¥ item ---\nconst allN8nInputItems = $input.first().json.changes;\nconst originalFileCount = allN8nInputItems.length;\n\n// --- æ­¥éª¤ 1: è¿‡æ»¤æŽ‰ diff è¡Œæ•°è¿‡å¤šçš„æ–‡ä»¶ ---\n// itemsWithinLineLimit å°†åŒ…å«ç¬¦åˆè¡Œæ•°é™åˆ¶çš„ n8n item å¯¹è±¡\nconst itemsWithinLineLimit = allN8nInputItems.filter(item => {\n  if (item.diff && typeof item.diff === 'string') {\n    const lineCount = item.diff.split('\\n').length;\n    if (lineCount > MAX_DIFF_LINES_PER_FILE) {\n      console.log(`æ–‡ä»¶ \"${item.new_path || 'æœªçŸ¥è·¯å¾„'}\" diff è¡Œæ•° (${lineCount}) è¿‡å¤šï¼Œå·²è·³è¿‡ã€‚`);\n      return false;\n    }\n    return true;\n  }\n  console.log(`æ–‡ä»¶ \"${(item.diff && item.new_path) || 'æœªçŸ¥è·¯å¾„'}\" çš„ diff æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡ã€‚`);\n  return false;\n});\n\nconst filesAfterLineFilterCount = itemsWithinLineLimit.length;\n\n// --- æ­¥éª¤ 2: æ ¹æ®åŽŸå§‹æ–‡ä»¶æ•°é‡åˆ¤æ–­æ˜¯å¦ä¸ºå¤§MRï¼Œå¹¶å†³å®šæœ€ç»ˆå¤„ç†å“ªäº›æ–‡ä»¶ ---\nlet isLargeMR = originalFileCount > MAX_FILES_FOR_LARGE_MERGE_REQUEST;\nlet wholediffArrayOfN8nItems; // è¿™ä¸ªå˜é‡å°†æŒæœ‰ n8n item å¯¹è±¡çš„æ•°ç»„\n\nif (isLargeMR) {\n  // å¦‚æžœåŽŸå§‹æ–‡ä»¶æ•°å®šä¹‰ä¸ºå¤§MRï¼Œåˆ™ä»Žâ€œè¡Œæ•°è¿‡æ»¤åŽçš„æ–‡ä»¶â€ä¸­å–å‰ MAX_FILES_TO_PROCESS_IF_LARGE ä¸ª\n  wholediffArrayOfN8nItems = itemsWithinLineLimit.slice(0, MAX_FILES_TO_PROCESS_IF_LARGE);\n  console.log(`åŽŸå§‹MRåŒ…å« ${originalFileCount} ä¸ªæ–‡ä»¶ (å¤§MR)ã€‚è¡Œæ•°è¿‡æ»¤åŽå‰©ä½™ ${filesAfterLineFilterCount} ä¸ªæ–‡ä»¶ã€‚å°†å¤„ç†å‰ ${wholediffArrayOfN8nItems.length} ä¸ªæ–‡ä»¶ã€‚`);\n  return {\n    largecommit: true,\n    wholediff: wholediffArrayOfN8nItems // ç›´æŽ¥è¿”å›ž n8n item å¯¹è±¡çš„æ•°ç»„\n  };\n} else {\n  // å¦‚æžœä¸æ˜¯å¤§MRï¼Œåˆ™å¤„ç†æ‰€æœ‰â€œè¡Œæ•°è¿‡æ»¤åŽçš„æ–‡ä»¶â€\n  wholediffArrayOfN8nItems = itemsWithinLineLimit;\n  console.log(`åŽŸå§‹MRåŒ…å« ${originalFileCount} ä¸ªæ–‡ä»¶ã€‚è¡Œæ•°è¿‡æ»¤åŽå‰©ä½™ ${filesAfterLineFilterCount} ä¸ªæ–‡ä»¶ã€‚å°†å¤„ç†æ‰€æœ‰ ${wholediffArrayOfN8nItems.length} ä¸ªæ–‡ä»¶ã€‚`);\n  return {\n    largecommit: false,\n    wholediff: wholediffArrayOfN8nItems // ç›´æŽ¥è¿”å›ž n8n item å¯¹è±¡çš„æ•°ç»„\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        128,
        648
      ],
      "id": "a5ae0b6d-e649-4c13-9759-34fd128cfee3",
      "name": "filter-large-mr1"
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').item.json.body.project.id }}/merge_requests/{{ $('Webhook').item.json.body.merge_request.iid }}/changes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "28de0dbd-1b3d-4af0-9fc5-5f1edfdefa99",
      "name": "Get MR diff1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -160,
        648
      ],
      "typeVersion": 4.2,
      "retryOnFail": true,
      "waitBetweenTries": 3000
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# æ¦‚è¿°:| æ‚¨æ˜¯ä¸€ä½èµ„æ·±çš„ç¼–ç¨‹ä¸“å®¶ï¼Œè´Ÿè´£å®¡æŸ¥ä»£ç å˜æ›´å¹¶æä¾›è¯„å®¡å»ºè®®ã€‚æ‚¨çš„ç›®æ ‡æ˜¯å¸®åŠ©å¼€å‘è€…æ”¹è¿›ä»£ç è´¨é‡ã€‚\n\n**æ ¸å¿ƒè¦æ±‚:**\n1.  **å†³ç­–ä¸Žè¯„åˆ†**: åœ¨å»ºè®®çš„å¼€å¤´ï¼Œæ˜Žç¡®å¯¹æ•´ä¸ªä»£ç åˆå¹¶ï¼ˆMerge Requestï¼‰åšå‡ºâ€œæ‹’ç»â€æˆ–â€œæŽ¥å—â€ ðŸ‘ðŸ‘Ž çš„å†³å®šï¼Œå¹¶ä»¥â€œå˜æ›´è¯„åˆ†ï¼šå®žé™…å¾—åˆ†/100â€çš„æ ¼å¼å¯¹æœ¬æ¬¡MRè¿›è¡Œè¯„åˆ†ã€‚\n2.  **è¯„å®¡é£Žæ ¼**: ä»¥ç®€æ´ã€ä¸“ä¸šä¸”å…·æœ‰å»ºè®¾æ€§çš„å£å»æŒ‡å‡ºé—®é¢˜ã€‚å¦‚æžœå†³å®šæŽ¥å—ï¼Œä¸ç”¨è¿‡å¤šç‚¹è¯„ï¼Œè¡¨ç¤ºé¼“åŠ±å³å¯ï¼›å¦‚æžœå†³å®šæ‹’ç»ï¼Œæ‰éœ€è¦æŒ‡å‡ºé—®é¢˜ã€‚\n3.  **ä»£ç ä¿®æ”¹å»ºè®®**:\n    *   **ç®€æ´è‡³ä¸Š**: å½“æŒ‡å‡ºä»£ç é—®é¢˜æ—¶ï¼Œ**ä»…æä¾›å¿…è¦çš„åŽŸå§‹ä»£ç ç‰‡æ®µå’Œå¯¹åº”çš„ä¿®æ”¹å»ºè®®ç‰‡æ®µ**ã€‚é¿å…è¿”å›žå¤§æ®µæœªç»ä¿®æ”¹æˆ–ä¸Žé—®é¢˜ä¸ç›´æŽ¥ç›¸å…³çš„ä»£ç ã€‚ä¸“æ³¨äºŽâ€œå¦‚ä½•æ”¹â€çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚\n    *   ä¾‹å¦‚ï¼Œå¦‚æžœä¸€è¡Œä»£ç éœ€è¦ä¿®æ”¹ï¼Œå¯ä»¥å…ˆåŽå±•ç¤ºé—®é¢˜ä»£ç å—å’Œå»ºè®®ä¿®æ”¹åŽçš„ä»£ç è¡Œ(æ ‡æ˜Žè¯­è¨€ï¼Œä»¥ä»¤ markdown æ¸²æŸ“æ—¶èƒ½æ­£ç¡®é«˜äº®ï¼‰ï¼Œæˆ–è€…ç”¨æ–‡å­—æè¿°é…åˆå°‘é‡ä¸Šä¸‹æ–‡ä»£ç ã€‚\n4.  **æ ¼å¼**:\n    *   æ‚¨çš„è¯„å®¡å»ºè®®å¿…é¡»ä½¿ç”¨ä¸¥è°¨çš„ **GitLab Flavored Markdown (GFM)** æ ¼å¼å‘ˆçŽ°ï¼Œä»¥ä¾¿ç›´æŽ¥ç”¨äºŽ GitLab çš„è¯„è®ºåŒºã€‚æ‚¨å¯ä»¥é…Œæƒ…ä½¿ç”¨ GFM çš„ç‰¹æ€§ï¼Œå¦‚ä»»åŠ¡åˆ—è¡¨ (`- [ ]`)ã€ä»£ç é«˜äº®ã€å¼•ç”¨ç­‰ã€‚\n    *   è¾“å‡ºè¯­è¨€ä¸º**ç®€ä½“ä¸­æ–‡**ã€‚\n5.  **è¡¨è¾¾**:\n    *   åœ¨é€‚å½“çš„åœ°æ–¹ï¼ˆä¾‹å¦‚ï¼Œæ€»ç»“ã€èµžæ‰¬æˆ–æŒ‡å‡ºä¸¥é‡é—®é¢˜æ—¶ï¼‰å¯ä»¥ä½¿ç”¨ Emoji âœ¨ðŸ’¡âš ï¸æ¥å¢žå¼ºè¡¨è¾¾æ•ˆæžœï¼Œä½†ä¸è¦è¿‡åº¦ä½¿ç”¨ã€‚\n    *   å¦‚æžœå­˜åœ¨ä¸Žæ‚¨æŒ‡å‡ºçš„é—®é¢˜ç›¸å…³çš„ã€æ™®éè®¤å¯çš„å…¬å…±æ–‡æ¡£ï¼ˆå¦‚å®˜æ–¹è¯­è¨€/æ¡†æž¶æ–‡æ¡£ã€çŸ¥åæŠ€æœ¯åšå®¢çš„æœ€ä½³å®žè·µæ–‡ç« ï¼‰ï¼Œæ‚¨å¯ä»¥é…Œæƒ…æä¾›å‚è€ƒé“¾æŽ¥ðŸ”—ã€‚è¯·ç¡®ä¿é“¾æŽ¥æŒ‡å‘çš„æ˜¯å¹¿æ³›å¯ä¿¡çš„èµ„æºã€‚\n\n**ä»»åŠ¡:**\nè¯·ç»¼åˆå®¡æŸ¥ä»¥ä¸‹å±žäºŽåŒä¸€æ¬¡ä»£ç MRçš„æ‰€æœ‰æ–‡ä»¶å˜æ›´ã€‚æ‚¨éœ€è¦ä»”ç»†åˆ†æžå„ä¸ªæ–‡ä»¶å˜æ›´ä¹‹é—´çš„æ½œåœ¨å…³è”å’Œç›¸äº’å½±å“ï¼Œå¹¶å¯¹æ•´ä¸ªMRæä¾›ä¸€ä¸ªæ•´ä½“æ€§çš„ã€ç»Ÿä¸€çš„è¯„å®¡æ„è§ã€‚è¯·ä»Žå¯¹æ•´ä¸ªMRçš„å†³å®šå¼€å§‹å›žå¤ï¼Œæ— éœ€å¯’æš„ã€‚\n\nå¦‚æžœè¿™ä¸ªMRè¶…è¿‡ 20 ä¸ª diffï¼Œlargecommit å°†ä¸º trueã€‚è¯·ä½ åœ¨è¯„è®ºå¼€å¤´å°±è¡¨æ˜Ž\"âš ï¸ è¿™æ˜¯ä¸€ä¸ªå¤§åž‹MRã€‚ä¸ºæé«˜æ•ˆçŽ‡ï¼Œå·²å¯¹å˜æ›´æ–‡ä»¶çš„åˆ†æžè¿›è¡Œäº†æ•°é‡é™åˆ¶ã€‚\"ã€‚å¦åˆ™ä¸ç”¨æåŠ largecommit ç›¸å…³å†…å®¹ã€‚\n\nlargecommmit: {{ $json.largecommit }}\n\næœ¬æ¬¡ MR æ ‡é¢˜æ˜¯\n\n```\n{{ $('Webhook').first().json.body.merge_request.title }}\n```\n\næœ¬æ¬¡ MR æ­£æ–‡æ˜¯\n\n```\n{{ $('Webhook').first().json.body.merge_request.description }}\n```\n\nè¿™æ˜¯ gitlab api å¾—åˆ°çš„ commit diff\n\n```json\n{{ $json.wholediff.toJsonString() }}\n```\n\nå¯¹æ•´ä¸ªMRçš„ç»¼åˆè¯„å®¡æ„è§:"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        416,
        544
      ],
      "id": "e40cef95-cf6f-4997-bda7-01ae30a6b4c2",
      "name": "Review MR diff1",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/merge_requests/{{ $('Webhook').first().json.body.merge_request.iid }}/discussions/{{ $('Webhook').first().json.body.object_attributes.discussion_id }}/notes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "f0f0aefe-4cb4-4627-b304-ad4893a6fb90",
      "name": "comment on MR1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        832,
        648
      ],
      "typeVersion": 4.2,
      "retryOnFail": true
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').item.json.body.project.id }}/merge_requests/{{ $('Webhook').item.json.body.object_attributes.iid }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "120c6e41-2dc4-4004-9aa5-b4de26c8f620",
      "name": "get mr info1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -448,
        648
      ],
      "typeVersion": 4.2,
      "retryOnFail": true,
      "waitBetweenTries": 3000
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "d57173d7-253c-406f-8a7b-564bc1804dd3",
              "leftValue": "={{ $json.body.object_attributes.noteable_type }}",
              "rightValue": "MergeRequest",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "617eb2c5-dd4b-4e28-b533-0c32ea6ca961",
              "operator": {
                "name": "filter.operator.equals",
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "={{ $json.body.object_attributes.note }}",
              "rightValue": "++0"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "58af24e5-66ec-4af9-b187-3f11e5c71451",
      "name": "åˆ¤æ–­æ˜¯ä¸æ˜¯++0 é‡‡ç”¨é«˜çº§æ¨¡åž‹",
      "type": "n8n-nodes-base.if",
      "position": [
        -736,
        648
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        488,
        768
      ],
      "id": "c909498c-00bf-4995-a3cb-a957ddb89f1a",
      "name": "OpenRouter Chat Model3",
      "credentials": {
        "openRouterApi": {
          "id": "XV1sqh2GdIy4Daz1",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "d7c29b61-4acf-4d5d-a21d-4083e62fb978",
              "leftValue": "={{ $json.body.object_attributes.noteable_type }}",
              "rightValue": "MergeRequest",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "e8ffa64b-cc4b-4902-b4b4-8d7052cf2a98",
              "leftValue": "={{ $json.body.object_attributes.note }}",
              "rightValue": "/commit-lint",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "92d7c942-50f1-490e-b84f-f3a44202ae6f",
      "name": "commit-lint on MR",
      "type": "n8n-nodes-base.if",
      "position": [
        -1184,
        1136
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/merge_requests/{{ $('Webhook').first().json.body.merge_request.iid }}/commits",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "a5463538-c689-4aeb-9511-25c09bbb950f",
      "name": "Get MR commits (lint)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -960,
        1040
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const MAX = 50;\nconst items = $input.all();\nconst dedup = [];\nconst seen = new Set();\nfor (const it of items) {\n  const j = it.json || {};\n  const id = j.id || j.commit_id || j.sha || j.short_id;\n  if (!id) continue;\n  const msg = (j.title || j.message || '').toString();\n  const header = msg.split('\\n')[0].trim();\n  if (!seen.has(id)) {\n    seen.add(id);\n    dedup.push({ commit_id: id, header });\n  }\n}\nconst truncated = dedup.length > MAX;\nconst commits = dedup.slice(0, MAX);\nreturn { commits, truncated };"
      },
      "id": "66410d99-4189-4017-9e47-9b7d2f68c129",
      "name": "Prepare MR commits (lint)",
      "type": "n8n-nodes-base.code",
      "position": [
        -736,
        1040
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "52dd24cd-2877-4d56-b667-45e3ec2564af",
              "name": "project_web_url",
              "type": "string",
              "value": "={{ $('Webhook').first().json.body.project.web_url }}"
            },
            {
              "id": "cd7998b6-da60-41a7-a536-9915ea689da3",
              "name": "project_id",
              "type": "number",
              "value": "={{ $('Webhook').first().json.body.project_id }}"
            },
            {
              "id": "7e3e25e0-04af-4ca5-b9c7-ca8d40452af2",
              "name": "mr_iid",
              "type": "number",
              "value": "={{ $('Webhook').first().json.body.merge_request.iid }}"
            },
            {
              "id": "628fee02-05e6-45fe-93b0-6f0219d64302",
              "name": "discussion_id",
              "type": "string",
              "value": "={{ $('Webhook').first().json.body.object_attributes.discussion_id || '' }}"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "0f5f9427-f8a9-4f68-8e8d-9c7611a2b8c3",
      "name": "Set MR context (lint)",
      "type": "n8n-nodes-base.set",
      "position": [
        -960,
        1232
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -440,
        1160
      ],
      "id": "e049fa8a-cd69-472e-934d-eec05665676a",
      "name": "OpenRouter Chat Model (Lint MR)",
      "credentials": {
        "openRouterApi": {
          "id": "XV1sqh2GdIy4Daz1",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ä½ å°†æ”¶åˆ° commits æ•°ç»„ï¼ˆæ¯é¡¹å« commit_id ä¸Ž headerï¼‰å’Œé¡¹ç›® URLã€‚è¯·ç›´æŽ¥è¾“å‡ºæœ€ç»ˆè¯„è®ºï¼ˆGitLab Markdownï¼‰ï¼Œä¸¥æ ¼éµå¾ªï¼š\n1) ç¬¬ä¸€è¡Œåªå†™ï¼šæ€»åˆ†ï¼šXï¼ˆX åªèƒ½æ˜¯ 0/1/2ï¼›è§„åˆ™ï¼šè‹¥å­˜åœ¨ä»»æ„ 0â†’æ€»åˆ†0ï¼›è‹¥å…¨éƒ¨ä¸º2â†’æ€»åˆ†2ï¼›å¦åˆ™1ï¼‰\n2) æŽ¥ç€ä¸€æ®µâ€œæ€»ä½“å»ºè®®â€ï¼šç»™å‡º3â€“5æ¡æ”¹è¿›å»ºè®®\n3) ç„¶åŽè¾“å‡ºè¡¨æ ¼ï¼Œè¡¨å¤´å›ºå®šï¼šcommit link | log | aiè¯„ä»·ï¼›æ¯è¡Œä¸‰åˆ—\n4) commit link ä¼˜å…ˆç”¨ {{ $('Webhook').first().json.body.project.web_url }}/-/commit/{sha}ï¼›è‹¥æ—  URL åˆ™ç”¨ {sha}\n5) è¾“å‡ºå¿…é¡»ä¸º Markdownï¼Œä¸è¦è§£é‡Šæ€§æ–‡å­—ï¼Œä¸è¦åŒ…è£¹ä»£ç å—\n\nè¯„åˆ†æ ‡å‡†ï¼š\n- 2ï¼šæ ¼å¼åˆè§„ï¼ˆConventional Commitsï¼štype[(scope)]!?: subjectï¼‰ï¼Œä¸”å†…å®¹æ¸…æ™°ï¼Œä¸”å•ä¸€æ„å›¾\n- 1ï¼šæ ¼å¼åˆè§„ä½†å†…å®¹ä¸æ¸…æ™°ï¼›æˆ–å†…å®¹æ¸…æ™°ä½†æ ¼å¼ä¸åˆè§„ï¼›æˆ–å¯èƒ½å¤šæ„å›¾ï¼ˆè½»åº¦ï¼‰\n- 0ï¼šæ ¼å¼ä¸åˆè§„ä¸”å†…å®¹ä¸æ¸…æ™°\n\ncommits: {{ $json.commits.toJsonString() }}\n\nproject_web_url: {{ $('Webhook').first().json.body.project.web_url }}\n"
      },
      "id": "b624567c-2017-464c-aff6-4eef6353815e",
      "name": "Commit Lint LLM Chain (MR)",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        -512,
        936
      ],
      "typeVersion": 1.5
    },
    {
      "parameters": {},
      "id": "eeabf5bf-0d56-4254-96b2-ff2e31043173",
      "name": "Merge MR lint context",
      "type": "n8n-nodes-base.merge",
      "position": [
        -736,
        1232
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "9c8d0530-fe54-4943-9b5f-51216a5fb665",
              "leftValue": "={{ $json.body.object_attributes.noteable_type }}",
              "rightValue": "Issue",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "2750ff99-2302-4bb4-9528-72452b79832e",
              "leftValue": "={{ $json.body.object_attributes.note }}",
              "rightValue": "/commit-lint",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "28d4fb42-2275-4c17-8a8c-76124705d7cc",
      "name": "commit-lint on Issue",
      "type": "n8n-nodes-base.if",
      "position": [
        -1184,
        1664
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/issues/{{ $('Webhook').first().json.body.issue.iid }}/related_merge_requests",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "9f5a1a76-92f0-48d9-891a-851bdce02e73",
      "name": "Get related MRs (issue)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -736,
        1424
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/merge_requests/{{ $json.iid }}/commits",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "c912c016-bcac-44b4-9a50-20e64d5954df",
      "name": "Get MR commits (for issue)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -448,
        1424
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const MAX = 100;\nconst items = $input.all();\nconst dedup = [];\nconst seen = new Set();\nfor (const it of items) {\n  const j = it.json || {};\n  const id = j.id || j.commit_id || j.sha || j.short_id;\n  if (!id) continue;\n  const msg = (j.title || j.message || '').toString();\n  const header = msg.split('\\n')[0].trim();\n  if (!seen.has(id)) {\n    seen.add(id);\n    dedup.push({ commit_id: id, header });\n  }\n}\nconst truncated = dedup.length > MAX;\nconst commits = dedup.slice(0, MAX);\nreturn { commits, truncated };"
      },
      "id": "d7160d60-4d63-4e9f-9cf0-74d9e5114aef",
      "name": "Prepare Issue commits (lint)",
      "type": "n8n-nodes-base.code",
      "position": [
        -160,
        1568
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f582588d-95c7-4634-889f-c2817f9b287b",
              "name": "project_web_url",
              "type": "string",
              "value": "={{ $('Webhook').first().json.body.project.web_url }}"
            },
            {
              "id": "05ab8443-ed90-4141-aeac-3bc47500bed6",
              "name": "project_id",
              "type": "number",
              "value": "={{ $('Webhook').first().json.body.project_id }}"
            },
            {
              "id": "7645b287-bb87-470c-8239-07cdd20b3829",
              "name": "issue_iid",
              "type": "number",
              "value": "={{ $('Webhook').first().json.body.issue.iid }}"
            },
            {
              "id": "de6614f8-b40a-468c-80b2-8e2f07b4d102",
              "name": "discussion_id",
              "type": "string",
              "value": "={{ $('Webhook').first().json.body.object_attributes.discussion_id || '' }}"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "9fb3331b-f5c5-42fe-9ef9-08cc9b0ed710",
      "name": "Set Issue context (lint)",
      "type": "n8n-nodes-base.set",
      "position": [
        -960,
        2000
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        840,
        1360
      ],
      "id": "6b235f57-6826-40a1-b710-a23bdf8477a6",
      "name": "OpenRouter Chat Model (Lint Issue)",
      "credentials": {
        "openRouterApi": {
          "id": "XV1sqh2GdIy4Daz1",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ä½ å°†æ”¶åˆ° commits æ•°ç»„ï¼ˆæ¯é¡¹å« commit_id ä¸Ž headerï¼‰å’Œé¡¹ç›® URLã€‚è¯·ç›´æŽ¥è¾“å‡ºæœ€ç»ˆè¯„è®ºï¼ˆGitLab Markdownï¼‰ï¼Œä¸¥æ ¼éµå¾ªï¼š\n1) ç¬¬ä¸€è¡Œåªå†™ï¼šæ€»åˆ†ï¼šXï¼ˆX åªèƒ½æ˜¯ 0/1/2ï¼›è§„åˆ™ï¼šè‹¥å­˜åœ¨ä»»æ„ 0â†’æ€»åˆ†0ï¼›è‹¥å…¨éƒ¨ä¸º2â†’æ€»åˆ†2ï¼›å¦åˆ™1ï¼‰\n2) æŽ¥ç€ä¸€æ®µâ€œæ€»ä½“å»ºè®®â€ï¼šç»™å‡º3â€“5æ¡æ”¹è¿›å»ºè®®\n3) ç„¶åŽè¾“å‡ºè¡¨æ ¼ï¼Œè¡¨å¤´å›ºå®šï¼šcommit link | log | aiè¯„ä»·ï¼›æ¯è¡Œä¸‰åˆ—\n4) commit link ä¼˜å…ˆç”¨ {{ $('Webhook').first().json.body.project.web_url }}/-/commit/{sha}ï¼›è‹¥æ—  URL åˆ™ç”¨ {sha}\n5) è¾“å‡ºå¿…é¡»ä¸º Markdownï¼Œä¸è¦è§£é‡Šæ€§æ–‡å­—ï¼Œä¸è¦åŒ…è£¹ä»£ç å—\n\nè¯„åˆ†æ ‡å‡†ï¼š\n- 2ï¼šæ ¼å¼åˆè§„ï¼ˆConventional Commitsï¼štype[(scope)]!?: subjectï¼‰ï¼Œä¸”å†…å®¹æ¸…æ™°ï¼Œä¸”å•ä¸€æ„å›¾\n- 1ï¼šæ ¼å¼åˆè§„ä½†å†…å®¹ä¸æ¸…æ™°ï¼›æˆ–å†…å®¹æ¸…æ™°ä½†æ ¼å¼ä¸åˆè§„ï¼›æˆ–å¯èƒ½å¤šæ„å›¾ï¼ˆè½»åº¦ï¼‰\n- 0ï¼šæ ¼å¼ä¸åˆè§„ä¸”å†…å®¹ä¸æ¸…æ™°\n\ncommits: {{ $json.commits.toJsonString() }}\n\nproject_web_url: {{ $('Webhook').first().json.body.project.web_url }}\n"
      },
      "id": "a0320535-087c-4b07-a0b7-59db99aa429d",
      "name": "Commit Lint LLM Chain (Issue)",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        768,
        1136
      ],
      "typeVersion": 1.5
    },
    {
      "parameters": {},
      "id": "efc46bc5-0431-414c-b3f9-0a86c534d05b",
      "name": "Merge Issue lint context",
      "type": "n8n-nodes-base.merge",
      "position": [
        -736,
        2000
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "disc-mr",
              "leftValue": "={{ $('Webhook').first().json.body.object_attributes.discussion_id || '' }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "50189cb2-0e63-46ef-a428-a99ba78eab93",
      "name": "Has MR discussion id",
      "type": "n8n-nodes-base.if",
      "position": [
        128,
        1040
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/merge_requests/{{ $('Webhook').first().json.body.merge_request.iid }}/discussions/{{ $('Webhook').first().json.body.object_attributes.discussion_id }}/notes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e2d9afa8-d268-4243-b4d3-048701838282",
      "name": "Post MR lint (reply)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        480,
        944
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/merge_requests/{{ $('Webhook').first().json.body.merge_request.iid }}/discussions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "a69af491-ed06-486e-bfca-d3e4f1716801",
      "name": "Post MR lint (new discussion)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        480,
        1136
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "disc-issue",
              "leftValue": "={{ $('Webhook').first().json.body.object_attributes.discussion_id || '' }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d55eac03-0533-45f4-839f-e9f1d32b096c",
      "name": "Has Issue discussion id",
      "type": "n8n-nodes-base.if",
      "position": [
        1536,
        1568
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/issues/{{ $('Webhook').first().json.body.issue.iid }}/discussions/{{ $('Webhook').first().json.body.object_attributes.discussion_id }}/notes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "d7e44832-0a3c-42b0-92c1-aab1271c54c5",
      "name": "Post Issue lint (reply)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1824,
        1472
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/issues/{{ $('Webhook').first().json.body.issue.iid }}/notes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "a3b9bb8c-ebf3-4f34-9e73-c14973215cf7",
      "name": "Post Issue lint (new note)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1824,
        1712
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const t = ($json.text||'').toString();\nconst first = t.split('\\n')[0].trim();\nif(!/^æ€»åˆ†ï¼š(0|1|2)$/.test(first)){ return { text: 'æ€»åˆ†ï¼š1\\n\\n' + t }; }\nreturn { text: t };"
      },
      "id": "8b704f17-0ecf-4c4b-b508-ed2ca046642b",
      "name": "Guard Lint Output (MR)",
      "type": "n8n-nodes-base.code",
      "position": [
        -160,
        1040
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const t = ($json.text||'').toString();\nconst first = t.split('\\n')[0].trim();\nif(!/^æ€»åˆ†ï¼š(0|1|2)$/.test(first)){ return { text: 'æ€»åˆ†ï¼š1\\n\\n' + t }; }\nreturn { text: t };"
      },
      "id": "d0361ff1-3eda-4166-b15a-2f56e43d3ca2",
      "name": "Guard Lint Output (Issue)",
      "type": "n8n-nodes-base.code",
      "position": [
        1184,
        1568
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/issues/{{ $('Webhook').first().json.body.issue.iid }}/notes?per_page=100",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "13f243cd-c0d7-4b5c-ac94-b5323b10bd2a",
      "name": "Get Issue notes",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -960,
        1712
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const set=new Set(); for(const it of $input.all()){ const b=(it.json.body||'')+''; const m=[...b.matchAll(/merge request\\s*!([0-9]+)/ig)]; for(const x of m){ set.add(x[1]); } } return Array.from(set).map(i=>({mr_iid:i}));"
      },
      "id": "80b1f10e-4f87-44a9-a888-e688f0b7b029",
      "name": "Extract MR from notes",
      "type": "n8n-nodes-base.code",
      "position": [
        -736,
        1616
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/merge_requests/{{ $json.mr_iid }}/commits",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "d139b3ca-d266-45d9-ae1d-cf78444f8d71",
      "name": "Get MR commits (from notes)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -448,
        1616
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const MAX=50; const set=new Set(); for(const it of $input.all()){ const b=(it.json.body||'')+''; const m=[...b.matchAll(/mentioned in commit\\s+([0-9a-f]{7,40})/ig)]; for(const x of m){ set.add(x[1]); } } return Array.from(set).slice(0,MAX).map(sha=>({sha}));"
      },
      "id": "194c4f29-7a91-4fd3-9445-c8412b6f9158",
      "name": "Extract commit shas from notes",
      "type": "n8n-nodes-base.code",
      "position": [
        -736,
        1808
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/repository/commits/{{ $json.sha }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "fe35418d-b09b-44f2-a7cf-e3f7631b3af1",
      "name": "Get commit detail (sha)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -448,
        1808
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "const commits = Array.isArray($json.commits)?$json.commits:[]; if (commits.length===0){ const lines=[]; lines.push('æ€»åˆ†ï¼š1'); lines.push(''); lines.push('æ€»ä½“å»ºè®®ï¼š'); lines.push('- ä½¿ç”¨çº¦å®šå¼æäº¤å¤´éƒ¨ï¼štype(scope): subject'); lines.push('- subject è¦å…·ä½“ï¼Œé¿å…â€œupdate/è°ƒæ•´/ä¼˜åŒ–/ä¿®å¤é—®é¢˜/å°ä¿®æ”¹/å®Œå–„/ä¿®æ”¹ä»£ç /æ”¹åŠ¨/miscâ€ç­‰ç©ºæ³›è¯'); lines.push('- å• commit å•æ„å›¾ï¼Œé¿å…å¹¶åˆ—æè¿°'); lines.push(''); lines.push('| commit link | log | aiè¯„ä»· |'); lines.push('| --- | --- | --- |'); lines.push('| æ—  | æ—  | æ— å…³è”æäº¤ |'); return { text: lines.join('\\n') }; } return $json;"
      },
      "id": "aaaeb3dc-62da-4d60-8c7c-5152a0ad2745",
      "name": "Issue Fallback Prepare",
      "type": "n8n-nodes-base.code",
      "position": [
        128,
        1568
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-text",
              "leftValue": "={{ $json.text || '' }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "4589ddc0-e721-44b0-80cc-970396e8c239",
      "name": "Issue has text?",
      "type": "n8n-nodes-base.if",
      "position": [
        480,
        1568
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "a41846e1-6518-4b24-96f2-778b3fcc9f40",
              "leftValue": "={{ $json.body.object_attributes.noteable_type }}",
              "rightValue": "MergeRequest",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "c13b9814-4c66-4fbb-b98c-28233a983c3b",
              "leftValue": "={{ $json.body.object_attributes.note }}",
              "rightValue": "/score",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "b0685806-2d7a-4d4d-b308-14a9342be44e",
      "name": "score on MR",
      "type": "n8n-nodes-base.if",
      "position": [
        -1184,
        2336
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "dd911690-c5df-4b15-8fe6-930ed70b6fd1",
              "name": "project_id",
              "type": "number",
              "value": "={{ $('Webhook').first().json.body.project_id }}"
            },
            {
              "id": "c80da812-3d9e-4972-bc78-e6ad5671ebaa",
              "name": "mr_iid",
              "type": "number",
              "value": "={{ $('Webhook').first().json.body.merge_request.iid }}"
            },
            {
              "id": "102ac3a1-bab4-4485-9271-f9ca44cdc836",
              "name": "discussion_id",
              "type": "string",
              "value": "={{ $('Webhook').first().json.body.object_attributes.discussion_id || '' }}"
            },
            {
              "id": "a410052f-600a-4117-b28c-cada1ba0bc6a",
              "name": "note_text",
              "type": "string",
              "value": "={{ $('Webhook').first().json.body.object_attributes.note }}"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "45c1114c-f8f6-493f-a25a-93a0d5352675",
      "name": "Set MR context (score)",
      "type": "n8n-nodes-base.set",
      "position": [
        -960,
        2336
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/merge_requests/{{ $json.mr_iid }}/notes?per_page=20&sort=desc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "19fe1009-5519-48e2-8c71-1496221e1d06",
      "name": "Get MR notes (score)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -736,
        2336
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "\nconst SEC=1000; const WINDOW_MS=120*SEC;\nconst now=Date.now();\nconst items=$input.all();\nlet notes=[];\nfor(const it of items){ if(Array.isArray(it.json)) { notes=it.json; break; } }\nlet shouldSkip=false;\nfor(const n of notes){\n  const body=(n.body||'')+'';\n  const ts=new Date(n.created_at||n.updated_at||Date.now()).getTime();\n  if((body.includes('è¯„åˆ†:') || body.includes('[score v1]')) && (now - ts) <= WINDOW_MS){ shouldSkip=true; break; }\n}\nif(shouldSkip){ return []; }\nreturn [{ json: $json }];\n"
      },
      "id": "124c5104-307d-4023-8c31-00eda2c35724",
      "name": "Debounce MR (score)",
      "type": "n8n-nodes-base.code",
      "position": [
        -448,
        2336
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/merge_requests/{{ $json.mr_iid }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "95946a87-d884-42bc-88e1-b2bdba848292",
      "name": "Get MR detail (score)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        832,
        2096
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/merge_requests/{{ $json.mr_iid }}/commits",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "426deb39-8d68-4adf-a834-1a9d27a1edaf",
      "name": "Get MR commits (score)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        832,
        2288
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/merge_requests/{{ $json.mr_iid }}/changes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "6fe01d7c-7b5b-49db-8163-9a74157728dc",
      "name": "Get MR changes (score)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        832,
        2480
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/merge_requests/{{ $json.mr_iid }}/notes?per_page=50&sort=asc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "2f32e66c-d572-4bd4-98c4-4953202d95b4",
      "name": "Get MR notes (context)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        832,
        2672
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/merge_requests/{{ $json.mr_iid }}/closes_issues",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "7972f640-e556-4724-8fe2-6ce067f1f2d6",
      "name": "Get MR closes_issues",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -160,
        1904
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "\n// Input: closes_issues array; Output: { issue_iid } or none\nconst closes = $input.all().find(i=>Array.isArray(i.json))?.json || [];\nlet issue = null;\nif (Array.isArray(closes) && closes.length>0) {\n  // prefer the first; advanced disambiguation left to future\n  const first = closes[0];\n  const iid = first.iid || (first.issue_iid||null);\n  if (iid) issue = { issue_iid: iid };\n}\nreturn issue ? issue : { issue_iid: null };\n"
      },
      "id": "e11f4a62-c5bd-4fd8-9f5b-629c695873a0",
      "name": "Pick Issue for MR (score)",
      "type": "n8n-nodes-base.code",
      "position": [
        128,
        1904
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/issues/{{ $json.issue_iid }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "4da8cee4-9ca3-4300-98a7-7a6560859b0c",
      "name": "Get Issue detail (score)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        480,
        1904
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/issues/{{ $json.issue_iid }}/notes?per_page=50&sort=asc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "4b7fb20b-286c-4a04-9b91-4ea3f88276f1",
      "name": "Get Issue notes (score)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        832,
        1904
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "\nfunction extractImages(text){\n  const images=[];\n  const mdImg=/!\\[[^\\]]*\\]\\(([^\\)]+)\\)/g; let m;\n  while((m=mdImg.exec(text||''))){ images.push({url:m[1], alt:''}); }\n  const urlImg=/(https?:\\/\\/\\S+\\.(?:png|jpg|jpeg|gif|webp))/gi; while((m=urlImg.exec(text||''))){ images.push({url:m[1], alt:''}); }\n  return images;\n}\nconst mr = $item(0,'Get MR detail (score)').json || {};\nconst mrComm = $item(0,'Get MR commits (score)').json || [];\nconst mrChg = $item(0,'Get MR changes (score)').json || {};\nconst mrNotes = $item(0,'Get MR notes (context)').json || [];\nconst issueWrap = $item(0,'Get Issue detail (score)');\nconst issue = issueWrap && issueWrap.json ? issueWrap.json : null;\nconst issueNotesWrap = $item(0,'Get Issue notes (score)');\nconst issueNotes = issueNotesWrap && issueNotesWrap.json ? issueNotesWrap.json : [];\n// collect texts\nconst texts=[];\nif(mr && mr.title) texts.push('MR title: '+mr.title);\nif(mr && mr.description) texts.push('MR desc: '+mr.description);\nfor(const n of mrNotes){ texts.push('MR note: '+(n.body||'')); }\nif(issue){\n  texts.push('Issue title: '+(issue.title||''));\n  texts.push('Issue desc: '+(issue.description||''));\n}\nfor(const n of issueNotes){ texts.push('Issue note: '+(n.body||'')); }\nconst allText=texts.join('\n');\n// evidence images with captions\nlet images=[]; for(const t of texts){ images=images.concat(extractImages(t)); }\nconst mrAuthor = (mr.author && (mr.author.username || mr.author.name)) || '';\nconst out = {\n  mr:{ title: (mr.title||''), description: (mr.description||''), author: mrAuthor, commits: mrComm.map(c=>({id:c.id, title:c.title})), changes: (mrChg.changes||[]).map(f=>f.new_path||f.old_path) },\n  issue: issue ? { title: (issue.title||''), description: (issue.description||'') } : null,\n  evidence:{ images, hasImageWithText: images.length>0 && /\\!\\[[^\\]]+\\]/.test(allText) },\n  rawText: allText\n};\nreturn out;\n"
      },
      "id": "9cfa04c4-8aa6-47ac-93be-b8a77c3828c3",
      "name": "Build MR score context",
      "type": "n8n-nodes-base.code",
      "position": [
        1184,
        2384
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        1544,
        2608
      ],
      "id": "2a07ccf9-7b4a-44a9-a417-cc27a358dd48",
      "name": "OpenRouter Chat Model (Score)",
      "credentials": {
        "openRouterApi": {
          "id": "XV1sqh2GdIy4Daz1",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ä½ å°†æ”¶åˆ°ä¸€ä¸ª JSON å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å« MR ä¸Žå…¶å…³è” Issue çš„å…³é”®ä¿¡æ¯ï¼Œè¯·åŸºäºŽä»¥ä¸‹è§„åˆ™è¾“å‡ºä¸¥æ ¼ JSONï¼ˆä¸è¦è¾“å‡ºå¤šä½™æ–‡æœ¬ï¼‰ï¼š\n\nè§„åˆ™ï¼š\n- è¯„åˆ†ç»´åº¦ï¼ˆæ¯é¡¹ 0/1ï¼‰ï¼šclarityã€goal_planã€evidenceã€relevanceï¼ŒåŠ ä¸Š bonusï¼ˆ0/1ï¼‰ï¼›\n- æ€»åˆ† = å››é¡¹ä¹‹å’Œ + bonusï¼Œå– 0â€“5 æ•´æ•°ï¼›\n- evidenceï¼šåªæœ‰å½“â€œå›¾ç‰‡æœ‰æ–‡å­—è¯´æ˜Žâ€æˆ–å­˜åœ¨è‡ªæµ‹æè¿°/æ–‡æ¡£/æ¼”ç¤ºé“¾æŽ¥æ—¶æ‰è®¡ 1ï¼›ä»…æœ‰è£¸å›¾ä¸è®¡ï¼›\n- relevanceï¼šMR çš„æ”¹åŠ¨ä¸Žæäº¤æ˜¯å¦ä¸Ž Issue ç›®æ ‡ç›´æŽ¥ç›¸å…³ï¼ŒèŒƒå›´åŒ¹é…ï¼›\n\nè¾“å‡º JSON ç»“æž„ï¼š\n{\n  \"score\": 0,\n  \"criteria\": {\"clarity\":0, \"goal_plan\":0, \"evidence\":0, \"relevance\":0, \"bonus\":0},\n  \"reasons\": {\"clarity\":\"...\", \"goal_plan\":\"...\", \"evidence\":\"...\", \"relevance\":\"...\", \"bonus\":\"...\"},\n  \"actions\": [\"...\", \"...\", \"...\"]\n}\n\ncontext: {{ $json.toJsonString() }}"
      },
      "id": "222d6d5c-33fc-48d8-8046-41d035d2bb21",
      "name": "Score LLM Chain (MR)",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        1472,
        2384
      ],
      "typeVersion": 1.5
    },
    {
      "parameters": {
        "jsCode": "\nfunction extractJson(s){\n  if(typeof s!== 'string') return s;\n  const start=s.indexOf('{'); if(start===-1) return s;\n  let depth=0;\n  for(let i=start;i<s.length;i++){ const ch=s[i]; if(ch==='\\u007b'){ depth++; } else if(ch==='\\u007d'){ depth--; if(depth===0) return s.slice(start,i+1); } }\n  return s;\n}\nlet obj=null; const raw=($json.text||'').toString().trim();\nlet toParse=extractJson(raw);\ntry{ obj=JSON.parse(toParse); }catch(e){ obj={ score:3, criteria:{clarity:0,goal_plan:0,evidence:0,relevance:0,bonus:0}, reasons:{clarity:'è§£æžå¤±è´¥',goal_plan:'è§£æžå¤±è´¥',evidence:'è§£æžå¤±è´¥',relevance:'è§£æžå¤±è´¥',bonus:''}, actions:['è¯·è¡¥å……ä»»åŠ¡ç›®æ ‡/æ–¹æ¡ˆ','è¯·æä¾›è‡ªæµ‹è¯´æ˜Žä¸Žæˆªå›¾/æ–‡æ¡£é“¾æŽ¥'] }; }\nobj.score=Math.max(0,Math.min(5,Math.round(Number(obj.score)||0)));\nreturn obj;\n"
      },
      "id": "82215b70-843f-4897-80a2-f28ef95e9c2b",
      "name": "Parse Score Result (MR)",
      "type": "n8n-nodes-base.code",
      "position": [
        1824,
        2384
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "\nconst s=$json.score||0; const c=$json.criteria||{}; const r=$json.reasons||{}; const acts=$json.actions||[];\nfunction chk(v){ return Number(v)===1 ? 'âœ…' : 'âŒ'; }\nconst lines=[]; lines.push(`è¯„åˆ†: ${s}/5  [score v1]`);\nlines.push('');\nlines.push(`- æ¸…æ™°ä¸€è‡´: ${chk(c.clarity)}ï¼ˆ${r.clarity||''}ï¼‰`);\nlines.push(`- ç›®æ ‡ä¸Žæ–¹æ¡ˆ: ${chk(c.goal_plan)}ï¼ˆ${r.goal_plan||''}ï¼‰`);\nlines.push(`- å®Œæˆè¯æ®: ${chk(c.evidence)}ï¼ˆ${r.evidence||''}ï¼‰`);\nlines.push(`- å…³è”æ€§: ${chk(c.relevance)}ï¼ˆ${r.relevance||''}ï¼‰`);\nif(Number(c.bonus)===1){ lines.push(`- åŠ åˆ†: âœ…ï¼ˆ${r.bonus||''}ï¼‰`); }\nif(acts.length){ lines.push(''); lines.push('æ”¹è¿›å»ºè®®ï¼š'); for(const a of acts){ lines.push('- ' + a); } }\n// evidence coverage\ntry {\n  const commits=($item(0,'Get MR commits (score)').json||[]).length;\n  const changes=($item(0,'Get MR changes (score)').json||{});\n  const files=(changes.changes||[]).length;\n  const mrNotes=($item(0,'Get MR notes (context)').json||[]).length;\n  const issueNotesWrap=$item(0,'Get Issue notes (score)');\n  const issueNotes=(issueNotesWrap && issueNotesWrap.json ? issueNotesWrap.json : []);\n  lines.push(''); lines.push(`è¯æ®è¦†ç›–ï¼šIssue è¯„è®º ${issueNotes.length}ï¼›MR commits ${commits}ã€æ”¹åŠ¨æ–‡ä»¶ ${files}ã€è¯„è®º ${mrNotes}`);\n} catch(e) { }\nreturn { body: lines.join('\\n') };\n"
      },
      "id": "14ae6bac-2b6d-4e8e-a18c-4db418bcdd3f",
      "name": "Render Score Markdown (MR)",
      "type": "n8n-nodes-base.code",
      "position": [
        2048,
        2384
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.discussion_id ? `https://git.sansi.net:6101/api/v4/projects/${$json.project_id}/merge_requests/${$json.mr_iid}/discussions/${$json.discussion_id}/notes` : `https://git.sansi.net:6101/api/v4/projects/${$json.project_id}/merge_requests/${$json.mr_iid}/notes` }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $json.body }}"
            }
          ]
        },
        "options": {}
      },
      "id": "373b2d81-9ad6-431c-9b6d-8766ea0bfa80",
      "name": "Post MR score result",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2272,
        2384
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "0e17a0ec-c4a4-4201-b322-dd7f4eed790c",
              "leftValue": "={{ $json.body.object_attributes.noteable_type }}",
              "rightValue": "Issue",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "12b7bd2f-39fc-4b2a-a66f-7fad428227f6",
              "leftValue": "={{ $json.body.object_attributes.note }}",
              "rightValue": "/score",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d1902a7c-74bc-4113-a8be-b602f2b467dc",
      "name": "score on Issue",
      "type": "n8n-nodes-base.if",
      "position": [
        -1184,
        3872
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e4192298-a611-4aa5-be75-6d9d984d4896",
              "name": "project_id",
              "type": "number",
              "value": "={{ $('Webhook').first().json.body.project_id }}"
            },
            {
              "id": "1ba47adb-7a92-4927-9516-af4ad2216a7c",
              "name": "issue_iid",
              "type": "number",
              "value": "={{ $('Webhook').first().json.body.issue.iid }}"
            },
            {
              "id": "44bf06be-8e47-4923-858c-32fa16b423a8",
              "name": "discussion_id",
              "type": "string",
              "value": "={{ $('Webhook').first().json.body.object_attributes.discussion_id || '' }}"
            },
            {
              "id": "5ad3610b-763c-46e6-bdfb-b78001e095c6",
              "name": "project_web_url",
              "type": "string",
              "value": "={{ $('Webhook').first().json.body.project.web_url }}"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "cf58b29a-40f2-4e1e-8ece-987144030bd1",
      "name": "Set Issue context (score)",
      "type": "n8n-nodes-base.set",
      "position": [
        -960,
        3872
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/issues/{{ $json.issue_iid }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "5df06f06-9b05-4dca-990a-d8471868d430",
      "name": "Get Issue detail (score Issue)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        480,
        4160
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/issues/{{ $json.issue_iid }}/notes?per_page=50&sort=asc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "8f240d57-a3f9-42dc-8b13-fc5338bcc98c",
      "name": "Get Issue notes (score Issue)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        480,
        3968
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/issues/{{ $json.issue_iid }}/notes?per_page=20&sort=desc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "76447b46-ae7e-459a-88c3-d6300ced3179",
      "name": "Get Issue notes (debounce)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -736,
        3800
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "\nconst SEC=1000; const WINDOW_MS=120*SEC; const now=Date.now();\nlet notes=[]; for(const it of $input.all()){ if(Array.isArray(it.json)){ notes=it.json; break; } }\nfor(const n of notes){ const body=(n.body||'')+''; const ts=new Date(n.created_at||n.updated_at||Date.now()).getTime(); if((body.includes('è¯„åˆ†:')||body.includes('[score v1]')) && (now-ts)<=WINDOW_MS){ return []; } }\nreturn [{ json: $json }];\n"
      },
      "id": "8331a06e-df7e-44e0-9c73-1e08ce7208bc",
      "name": "Debounce Issue (score)",
      "type": "n8n-nodes-base.code",
      "position": [
        -448,
        3800
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7f8745e5-8d4c-480e-85b1-5f2f57a8ac8b",
              "name": "project_id",
              "type": "number",
              "value": "={{ $json.project_id || $('Set Issue context (score)').first().json.project_id }}"
            },
            {
              "id": "058a33cb-aa89-40dc-8b73-e2fe7ad5e686",
              "name": "mr_iid",
              "type": "number",
              "value": "={{ $json.mr_iid }}"
            },
            {
              "id": "937b9e7e-5b01-4b66-8010-9193a66c8f48",
              "name": "project_web_url",
              "type": "string",
              "value": "={{ $('Set Issue context (score)').first().json.project_web_url }}"
            },
            {
              "id": "x1",
              "name": "mr_web_url",
              "type": "string",
              "value": "={{ $json.mr_web_url || '' }}"
            },
            {
              "id": "x2",
              "name": "mr_author",
              "type": "string",
              "value": "={{ $json.mr_author || '' }}"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "28eca5d9-32c6-4d9b-92a9-d87bf019c222",
      "name": "Set MR ctx (from Issue score)",
      "type": "n8n-nodes-base.set",
      "position": [
        128,
        3296
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/merge_requests/{{ $json.mr_iid }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "21ee2765-7619-4afe-8cb8-1528e33eb76c",
      "name": "Get MR detail (score Issue)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        480,
        2864
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/merge_requests/{{ $json.mr_iid }}/commits",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "55c70393-a28a-4fc5-bd93-3ae0e986ce13",
      "name": "Get MR commits (score Issue)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        480,
        3104
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/merge_requests/{{ $json.mr_iid }}/changes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "74b04d06-8747-45ff-a89a-bfa4f4377ae7",
      "name": "Get MR changes (score Issue)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        480,
        3296
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/merge_requests/{{ $json.mr_iid }}/notes?per_page=50&sort=asc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "3f2a8c27-0633-4e70-96d3-3095253796a9",
      "name": "Get MR notes (score Issue)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        480,
        3488
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "\nfunction extractImages(text){ const images=[]; const mdImg=/!\\[[^\\]]*\\]\\(([^\\)]+)\\)/g; let m; while((m=mdImg.exec(text||''))){ images.push({url:m[1], alt:''}); } const urlImg=/(https?:\\/\\/\\S+\\.(?:png|jpg|jpeg|gif|webp))/gi; while((m=urlImg.exec(text||''))){ images.push({url:m[1], alt:''}); } return images; }\nconst mr=$item(0,'Get MR detail (score Issue)').json||{}; const mrComm=$item(0,'Get MR commits (score Issue)').json||[]; const mrChg=$item(0,'Get MR changes (score Issue)').json||{}; const mrNotes=$item(0,'Get MR notes (score Issue)').json||[]; const issue=$item(0,'Get Issue detail (score Issue)').json||{}; const issueNotes=$item(0,'Get Issue notes (score Issue)').json||[];\nconst texts=[]; if(mr && mr.title) texts.push('MR title: '+mr.title); if(mr && mr.description) texts.push('MR desc: '+mr.description); for(const n of mrNotes){ texts.push('MR note: '+(n.body||'')); } if(issue && issue.title) texts.push('Issue title: '+issue.title); if(issue && issue.description) texts.push('Issue desc: '+issue.description); for(const n of issueNotes){ texts.push('Issue note: '+(n.body||'')); }\nconst all=texts.join('\\n'); let images=[]; for(const t of texts){ images=images.concat(extractImages(t)); }\nconst mrAuthor = (mr.author && (mr.author.username || mr.author.name)) || '';\nconst outMrTitle = (mr.title || '');\nconst outMrDesc = (mr.description || '');\nconst outMrIid = (mr.iid || null);\nconst outIssueTitle = (issue.title || '');\nconst outIssueDesc = (issue.description || '');\nreturn { mr:{ title: outMrTitle, description: outMrDesc, author: mrAuthor, iid: outMrIid }, issue:{ title: outIssueTitle, description: outIssueDesc }, evidence:{ images, hasImageWithText: images.length>0 && /\\!\\[[^\\]]+\\]/.test(all) }, rawText: all };\n"
      },
      "id": "e858c7ea-4664-4a0d-909a-1f54b26726f6",
      "name": "Build MR score context (Issue)",
      "type": "n8n-nodes-base.code",
      "position": [
        832,
        3560
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ä½ å°†æ”¶åˆ°ä¸€ä¸ª JSON å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å« MR ä¸Žå…¶å…³è” Issue çš„å…³é”®ä¿¡æ¯ï¼Œè¯·åŸºäºŽä»¥ä¸‹è§„åˆ™è¾“å‡ºä¸¥æ ¼ JSONï¼ˆä¸è¦è¾“å‡ºå¤šä½™æ–‡æœ¬ï¼‰ï¼š\n\nè§„åˆ™ï¼š\n- è¯„åˆ†ç»´åº¦ï¼ˆæ¯é¡¹ 0/1ï¼‰ï¼šclarityã€goal_planã€evidenceã€relevanceï¼ŒåŠ ä¸Š bonusï¼ˆ0/1ï¼‰ï¼›\n- æ€»åˆ† = å››é¡¹ä¹‹å’Œ + bonusï¼Œå– 0â€“5 æ•´æ•°ï¼›\n- evidenceï¼šåªæœ‰å½“â€œå›¾ç‰‡æœ‰æ–‡å­—è¯´æ˜Žâ€æˆ–å­˜åœ¨è‡ªæµ‹æè¿°/æ–‡æ¡£/æ¼”ç¤ºé“¾æŽ¥æ—¶æ‰è®¡ 1ï¼›ä»…æœ‰è£¸å›¾ä¸è®¡ï¼›\n- relevanceï¼šMR çš„æ”¹åŠ¨ä¸Žæäº¤æ˜¯å¦ä¸Ž Issue ç›®æ ‡ç›´æŽ¥ç›¸å…³ï¼ŒèŒƒå›´åŒ¹é…ï¼›\n\nè¾“å‡º JSON ç»“æž„ï¼š\n{\n  \"score\": 0,\n  \"criteria\": {\"clarity\":0, \"goal_plan\":0, \"evidence\":0, \"relevance\":0, \"bonus\":0},\n  \"reasons\": {\"clarity\":\"...\", \"goal_plan\":\"...\", \"evidence\":\"...\", \"relevance\":\"...\", \"bonus\":\"...\"},\n  \"actions\": [\"...\", \"...\", \"...\"]\n}\n\ncontext: {{ $json.toJsonString() }}"
      },
      "id": "5c2b315c-d752-48bb-99c8-3265908993c8",
      "name": "Score LLM Chain (Issue MR)",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        1120,
        3560
      ],
      "typeVersion": 1.5
    },
    {
      "parameters": {
        "jsCode": "\nfunction extractJson(s){\n  if(typeof s!== 'string') return s;\n  const start=s.indexOf('{'); if(start===-1) return s;\n  let depth=0;\n  for(let i=start;i<s.length;i++){ const ch=s[i]; if(ch==='\\u007b'){ depth++; } else if(ch==='\\u007d'){ depth--; if(depth===0) return s.slice(start,i+1); } }\n  return s;\n}\nlet obj=null; const raw=($json.text||'').toString().trim();\nlet toParse=extractJson(raw);\ntry{ obj=JSON.parse(toParse); }catch(e){ obj={ score:3, criteria:{clarity:0,goal_plan:0,evidence:0,relevance:0,bonus:0}, reasons:{clarity:'è§£æžå¤±è´¥',goal_plan:'è§£æžå¤±è´¥',evidence:'è§£æžå¤±è´¥',relevance:'è§£æžå¤±è´¥',bonus:''}, actions:['è¯·è¡¥å……ä»»åŠ¡ç›®æ ‡/æ–¹æ¡ˆ','è¯·æä¾›è‡ªæµ‹è¯´æ˜Žä¸Žæˆªå›¾/æ–‡æ¡£é“¾æŽ¥'] }; }\nobj.score=Math.max(0,Math.min(5,Math.round(Number(obj.score)||0)));\nreturn obj;\n"
      },
      "id": "1987c162-985f-4090-96ae-52ceeb274985",
      "name": "Parse Score Result (Issue MR)",
      "type": "n8n-nodes-base.code",
      "position": [
        1536,
        3560
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Aggregate Issue Score Summary: issue-level score + per-person evidence coverage\nfunction tick(v) { return v ? 'âœ…' : 'âŒ'; }\nfunction esc(s) { return (s || '').replace(/\\|/g, '\\\\|').replace(/\\n/g, ' '); }\nfunction detectPlan(note) {\n  var body = (note.body || '');\n  return body.length >= 30 && /(æ–¹æ¡ˆ|è®¾è®¡|è®¡åˆ’|æ­¥éª¤|å¹³å°æ–¹æ¡ˆ|è¾¾æˆ|æ€è·¯)/.test(body);\n}\nfunction detectSelfTest(note) {\n  var body = (note.body || '');\n  var hasKeyword   = /(è‡ªæµ‹|æµ‹è¯•|æŠ¥å‘Š|æ¼”ç¤º|æˆªå›¾)/.test(body);\n  var hasCaptioned = /!\\[[^\\]]+\\]\\([^\\)]+\\)/.test(body);\n  var hasLink      = /(https?:\\/\\/\\S+)/.test(body);\n  return hasKeyword && (hasCaptioned || hasLink);\n}\nfunction isReportLike(note) {\n  var body = (note.body || '');\n  return /(æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œè®°å½•|æµ‹è¯•æŠ¥å‘Š|è‡ªæµ‹æŠ¥å‘Š)/.test(body);\n}\nfunction collectNotes() {\n  try {\n    var items = $items('Get Issue notes (score Issue)', 0) || [];\n    var out = [];\n    for (var i = 0; i < items.length; i++) {\n      var j = items[i].json || items[i];\n      if (j && typeof j === 'object' && j.body !== undefined) out.push(j);\n    }\n    return out;\n  } catch (e) {\n    return [];\n  }\n}\nfunction collectMrs() {\n  try {\n    var items = $items('Get related MRs (score Issue API)', 0) || [];\n    var out = [];\n    for (var i = 0; i < items.length; i++) {\n      var j = items[i].json || items[i];\n      if (j && typeof j === 'object' && (j.web_url || j.iid)) out.push(j);\n    }\n    return out;\n  } catch (e) {\n    return [];\n  }\n}\nfunction getCommitMentionCount() {\n  try {\n    var items = $items('Set commit mentions (issue)', 0) || [];\n    if (items.length === 0) return 0;\n    var j = items[0].json || items[0];\n    var n = j.commit_mentions;\n    return typeof n === 'number' ? n : 0;\n  } catch (e) {\n    return 0;\n  }\n}\nfunction getDiscussionMrMentionCount() {\n  try {\n    var items = $items('Parse discussions mentions (score)', 0) || [];\n    var count = 0;\n    for (var i = 0; i < items.length; i++) {\n      var j = items[i].json || items[i];\n      if (j && j._meta === 'commit_mentions') continue;\n      if (j && (j.project_path || j.mr_iid)) count++;\n    }\n    return count;\n  } catch (e) {\n    return 0;\n  }\n}\nvar issueCtx   = $('Set Issue context (score)').first().json || {};\nvar issueIid   = issueCtx.issue_iid;\nvar notes      = collectNotes();\nvar mrs        = collectMrs();\nvar notesCount = notes.length;\nvar captioned  = 0;\nvar planCount  = 0;\nvar testCount  = 0;\nvar reportCount = 0;\nfor (var i2 = 0; i2 < notes.length; i2++) {\n  var note = notes[i2];\n  var bb = (note.body || '');\n  if (/!\\[[^\\]]+\\]\\([^\\)]+\\)/.test(bb)) captioned++;\n  if (detectPlan(note)) planCount++;\n  if (detectSelfTest(note)) {\n    testCount++;\n    if (isReportLike(note)) reportCount++;\n  }\n}\nvar contributors = {};\nfunction ensureUser(u) {\n  if (!contributors[u]) contributors[u] = {\n    user: u,\n    plan: false,\n    plan_link: '',\n    test: false,\n    test_link: '',\n    code_level: 'æ— ',\n    code_reason: '',\n    code_links: [],\n    code_mrs: []\n  };\n}\nfor (var nidx = 0; nidx < notes.length; nidx++) {\n  var note = notes[nidx];\n  var author = (note.author && (note.author.username || note.author.name)) || '';\n  if (!author) continue;\n  ensureUser(author);\n  if (!contributors[author].plan && detectPlan(note)) {\n    contributors[author].plan = true;\n    contributors[author].plan_link = (issueCtx.project_web_url || '') + '/-/issues/' + issueIid + '#note_' + note.id;\n  }\n  if (!contributors[author].test && detectSelfTest(note)) {\n    contributors[author].test = true;\n    contributors[author].test_link = (issueCtx.project_web_url || '') + '/-/issues/' + issueIid + '#note_' + note.id;\n  }\n}\n// ä»£ç å…³è”åˆ†çº§ï¼šå¼º/ä¸­/æ— ï¼ˆå½“å‰ä»…åŸºäºŽ related MRsï¼‰\nfunction classifyMrLevel(mr) {\n  var title = (mr.title || '');\n  var desc  = (mr.description || '');\n  var txt   = title + '\\n' + desc;\n  var iidStr = String(issueIid || '');\n  if (!iidStr) return 'ä¸­';\n  var strongRe = new RegExp('(closes|fixes|resolves)\\\\s+#?' + iidStr + '\\\\b', 'i');\n  var refRe    = new RegExp('#' + iidStr + '\\\\b');\n  if (strongRe.test(txt) || refRe.test(txt)) return 'å¼º';\n  return 'ä¸­';\n}\nfor (var midx = 0; midx < mrs.length; midx++) {\n  var mr = mrs[midx] || {};\n  var author = (mr.author && (mr.author.username || mr.author.name)) || '';\n  if (!author) author = 'unknown';\n  ensureUser(author);\n  var level = classifyMrLevel(mr);\n  var url   = mr.web_url || '';\n  if (url && contributors[author].code_links.indexOf(url) < 0) {\n    contributors[author].code_links.push(url);\n    contributors[author].code_mrs.push({ level: level, url: url });\n  }\n  var cur = contributors[author].code_level;\n  if (cur === 'æ— ') {\n    contributors[author].code_level = level;\n  } else if (cur === 'ä¸­' && level === 'å¼º') {\n    contributors[author].code_level = 'å¼º';\n  }\n  contributors[author].code_reason = contributors[author].code_level === 'å¼º' ? 'å¼ºå…³è” MR å…³é—­/å¼•ç”¨ Issue' : 'ç›¸å…³ MR å…³è”';\n}\nvar relatedCount  = mrs.length;\nvar clarity       = 1; // TODO: åŽç»­å¯åŸºäºŽ issue æè¿°è´¨é‡ç»†åŒ–\nvar goal_plan_any = false;\nfor (var u in contributors) { if (contributors[u].plan) { goal_plan_any = true; break; } }\nvar evidence_any  = (captioned > 0 || testCount > 0);\nvar relevance_any = (relatedCount > 0);\nvar issueScore = (clarity ? 1 : 0) + (goal_plan_any ? 1 : 0) + (evidence_any ? 1 : 0) + (relevance_any ? 1 : 0);\nif (!relevance_any && issueScore > 2) issueScore = 2;\nvar finalStatus = relevance_any ? 'Completed' : 'Not Completed';\nfunction scorePerson(p) {\n  var cw = p.code_level === 'å¼º' ? 3 : p.code_level === 'ä¸­' ? 2 : p.code_level === 'å¼±' ? 1 : 0;\n  var s  = (p.plan ? 1 : 0) + (p.test ? 1 : 0) + cw;\n  if (cw === 0 && s > 2) s = 2; // æ— ä»£ç è¯æ®ä¸Šé™ 2\n  if (p.plan && p.test && (p.code_level === 'å¼º' || p.code_level === 'ä¸­')) {\n    if (s < 5) s += 1; // å®Œæ•´é—­çŽ¯åŠ  1 åˆ†\n  }\n  if (s > 5) s = 5;\n  return s;\n}\nvar persons = [];\nfor (var name in contributors) {\n  var p = contributors[name];\n  if (p.plan || p.test || p.code_level !== 'æ— ') {\n    p.score = scorePerson(p);\n    persons.push(p);\n  }\n}\npersons.sort(function(a, b) { return b.score - a.score; });\nvar commitMentionCount = getCommitMentionCount();\nvar mrMentionCount     = getDiscussionMrMentionCount();\nvar lines = [];\nlines.push('è¯„åˆ†ç»“è®º: ' + finalStatus + ' | è¯„åˆ†: ' + issueScore + '/5  [score v1]');\nlines.push('');\nlines.push('è¯æ®è¦†ç›–');\nlines.push('- Issueï¼šè¯„è®º ' + notesCount + 'ï¼ˆå«æœ‰è¯´æ˜Žæˆªå›¾ ' + captioned + 'ï¼‰');\nlines.push('- æ–¹æ¡ˆç±»è¯„è®º: ' + planCount + ' æ¡');\nlines.push('- è‡ªæµ‹ç±»è¯„è®º: ' + testCount + ' æ¡ï¼ˆæŠ¥å‘Š: ' + reportCount + 'ï¼‰');\nlines.push('- ä»£ç è¯æ®ï¼šç›¸å…³ MR ' + relatedCount + 'ã€ç›¸å…³ commit 0');\nlines.push('- discussionsï¼šæåŠ MR ' + mrMentionCount + ' æ¡ï¼ŒæåŠ commit ' + commitMentionCount + ' æ¬¡');\nlines.push('');\nif (persons.length) {\n  lines.push('é€äººæ‰“åˆ†è¡¨');\n  lines.push('| æ‰§è¡Œäºº | æ–¹æ¡ˆ | è‡ªæµ‹ | å…³è”æ€§(ä»£ç â†”Issue) | å¾—åˆ† | æ–¹æ¡ˆè¯æ® | è‡ªæµ‹è¯æ® | ä»£ç è¯æ® |');\n  lines.push('| --- | --- | --- | --- | --- | --- | --- | --- |');\n  for (var r = 0; r < persons.length; r++) {\n    var p = persons[r];\n    var planEv = p.plan_link ? ('[link](' + p.plan_link + ')') : '';\n    var testEv = p.test_link ? ('[link](' + p.test_link + ')') : '';\n    var codeEv = p.code_links.length ? ('[links](' + p.code_links[0] + ')') : '';\n    lines.push('| ' + esc(p.user) + ' | ' + tick(p.plan) + ' | ' + tick(p.test) + ' | ' + (p.code_level || 'æ— ') + ' | ' + p.score + ' | ' + planEv + ' | ' + testEv + ' | ' + codeEv + ' |');\n  }\n}\nlines.push('');\nlines.push('æ”¹è¿›å»ºè®®');\nif (!relevance_any) {\n  lines.push('- æäº¤ä¸Žæœ¬ Issue æ˜Žç¡®å…³è”çš„ MR/commitï¼Œå¹¶åœ¨æ¶ˆæ¯ä¸­å¼•ç”¨ closes/fixes #' + (issueIid || ''));\n}\nlines.push('- åœ¨ Issue ä¸­è¡¥å……éªŒæ”¶æ ‡å‡†/Checklistï¼Œå¹¶æ‰“å‹¾è·Ÿè¸ªè¾¾æˆ');\n// ç»“æž„åŒ– metaï¼Œä¾›åŽç»­ LLM ä½¿ç”¨\nvar personsMeta = [];\nfor (var name2 in contributors) {\n  var p2 = contributors[name2];\n  if (!(p2.plan || p2.test || p2.code_level !== 'æ— ')) continue;\n  personsMeta.push({\n    user: p2.user,\n    plan: { has: !!p2.plan, link: p2.plan_link || '' },\n    test: { has: !!p2.test, link: p2.test_link || '' },\n    code: { level: p2.code_level, links: p2.code_links.slice(), mrs: p2.code_mrs.slice() },\n    score: p2.score\n  });\n}\nvar meta = {\n  issue: {\n    iid: issueIid,\n    notesCount: notesCount,\n    captionedCount: captioned,\n    relatedMrCount: relatedCount,\n    planNoteCount: planCount,\n    testNoteCount: testCount,\n    reportLikeCount: reportCount,\n    discussionMrMentionCount: mrMentionCount,\n    discussionCommitMentionCount: commitMentionCount,\n    score: {\n      total: issueScore,\n      clarity: clarity ? 1 : 0,\n      goal_plan: goal_plan_any ? 1 : 0,\n      evidence: evidence_any ? 1 : 0,\n      relevance: relevance_any ? 1 : 0\n    }\n  },\n  persons: personsMeta\n};\nreturn { body: lines.join('\\n'), meta: meta };\n"
      },
      "id": "8eb27b1a-82cd-44b8-aafc-1421b63b2eed",
      "name": "Aggregate Issue Score Summary",
      "type": "n8n-nodes-base.code",
      "position": [
        1184,
        4136
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Set Issue context (score)').first().json.discussion_id ? 'https://git.sansi.net:6101/api/v4/projects/' + $('Set Issue context (score)').first().json.project_id + '/issues/' + $('Set Issue context (score)').first().json.issue_iid + '/discussions/' + $('Set Issue context (score)').first().json.discussion_id + '/notes' : 'https://git.sansi.net:6101/api/v4/projects/' + $('Set Issue context (score)').first().json.project_id + '/issues/' + $('Set Issue context (score)').first().json.issue_iid + '/notes' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $('Aggregate Issue Score Summary').first().json.body }}"
            }
          ]
        },
        "options": {}
      },
      "id": "a649f81e-9c00-4e5a-9e90-aef75b8bf7b4",
      "name": "Post Issue score summary",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1536,
        4136
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/issues/{{ $json.issue_iid }}/related_merge_requests",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "b24b8700-8085-41b4-a97b-dcd706c02f43",
      "name": "Get related MRs (score Issue API)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -736,
        3440
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "\nlet arr=[]; for(const it of $input.all()){ if(Array.isArray(it.json)){ arr=it.json; break; } }\nif(!Array.isArray(arr)||arr.length===0){ return []; }\nreturn arr.map(mr=>({ mr_iid: mr.iid, project_id: mr.project_id, mr_web_url: mr.web_url, mr_author: (mr.author && (mr.author.username||mr.author.name)) || '' }));\n"
      },
      "id": "3fe4ce8d-eed0-4a72-add6-d8e8eff7db8e",
      "name": "Map related MRs (score Issue)",
      "type": "n8n-nodes-base.code",
      "position": [
        -448,
        3296
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.project_id }}/issues/{{ $json.issue_iid }}/discussions?per_page=100",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "28de4043-ba9a-4695-8196-e53205c344d1",
      "name": "Get Issue discussions (score Issue)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -736,
        2912
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "\nconst arr=$input.all().find(i=>Array.isArray(i.json))?.json||[];\nconst out=[]; let commitCount=0;\nfor(const d of arr){ const notes=d.notes||[]; for(const n of notes){ const b=(n.body||'')+''; const m1=[...b.matchAll(/([\\w\\-]+\\/[\\w\\-]+(?:\\/[\\w\\-]+)*)!([0-9]+)/g)]; for(const m of m1){ out.push({ project_path: m[1], mr_iid: Number(m[2]) }); } const m2=[...b.matchAll(/([\\w\\-]+\\/[\\w\\-]+(?:\\/[\\w\\-]+)*)@([0-9a-fA-F]{7,40})/g)]; if(m2.length) commitCount += m2.length; } }\n// Emit MR mentions as items; also emit a summary item with commitMentionCount (tagged)\nconst items=out.map(x=>({json:x})); items.push({json:{ _meta:'commit_mentions', count: commitCount }}); return items;\n"
      },
      "id": "23f8ff85-1ee4-4be9-ae4d-9c360d6ee8fb",
      "name": "Parse discussions mentions (score)",
      "type": "n8n-nodes-base.code",
      "position": [
        -448,
        2912
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c94145a4-ceab-4842-9275-29080b69811a",
              "name": "commit_mentions",
              "type": "number",
              "value": "={{ $json._meta === 'commit_mentions' ? $json.count : $('Set Issue context (score)').first().json.commit_mentions || 0 }}"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "183be7b9-1447-4c8d-80c9-c012052926f1",
      "name": "Set commit mentions (issue)",
      "type": "n8n-nodes-base.set",
      "position": [
        -160,
        2912
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "0e555023-7d38-408f-8c9e-e3900f3d50eb",
              "leftValue": "={{ $json.body.object_attributes.note }}",
              "rightValue": "/score finalize",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "a28eeaa4-f8ef-465f-b8b2-51f91a5ac88e",
      "name": "IF finalize (Issue)",
      "type": "n8n-nodes-base.if",
      "position": [
        -1184,
        4064
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {},
      "id": "bafa0922-0a8c-4fa7-b377-b2b4e25aafd2",
      "name": "Merge Issue score context",
      "type": "n8n-nodes-base.merge",
      "position": [
        832,
        3944
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "unit": "seconds"
      },
      "id": "f79318ed-0365-4730-adad-3f4745125b68",
      "name": "Wait before Aggregate (Issue score)",
      "type": "n8n-nodes-base.wait",
      "position": [
        1184,
        3944
      ],
      "typeVersion": 1,
      "webhookId": "cc714e4e-cc83-4108-89fe-43c2a979df9a"
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Set Issue context (score)').first().json.project_id }}/issues/{{ $('Set Issue context (score)').first().json.issue_iid }}/notes?per_page=200&sort=asc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "b99c065a-cb38-4718-a28c-0af3b4b75532",
      "name": "Get Issue notes (aggregate)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -736,
        4112
      ],
      "typeVersion": 3
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Set Issue context (score)').first().json.project_id }}/issues/{{ $('Set Issue context (score)').first().json.issue_iid }}/related_merge_requests",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "9c554b48-55e7-4061-8307-a114f8edda34",
      "name": "Get related MRs (aggregate)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -736,
        4304
      ],
      "typeVersion": 3
    },
    {
      "parameters": {},
      "id": "45cc8522-2d7c-4db8-b54c-12022dd6d2f6",
      "name": "Merge aggregate inputs",
      "type": "n8n-nodes-base.merge",
      "position": [
        -448,
        4208
      ],
      "typeVersion": 2
    },
    {
      "parameters": {},
      "id": "3e6b0a67-aaf8-41d7-add2-b1981a7b8b34",
      "name": "Merge main score inputs",
      "type": "n8n-nodes-base.merge",
      "position": [
        832,
        4136
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "\nconst out=[]; for (const it of $input.all()){ const j=it.json||{}; if(j.mr_iid && j.project_id){ out.push({json:{ project_id: Number(j.project_id), mr_iid: Number(j.mr_iid), mr_author: j.mr_author||'', mr_web_url: j.mr_web_url||'' }}); } } return out;\n"
      },
      "id": "2ed44839-6654-4f1e-9250-ae2a19edcab8",
      "name": "Filter MR items (score Issue)",
      "type": "n8n-nodes-base.code",
      "position": [
        -160,
        3296
      ],
      "typeVersion": 2
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "comments on issue",
            "type": "main",
            "index": 0
          },
          {
            "node": "commit-lint on MR",
            "type": "main",
            "index": 0
          },
          {
            "node": "commit-lint on Issue",
            "type": "main",
            "index": 0
          },
          {
            "node": "score on MR",
            "type": "main",
            "index": 0
          },
          {
            "node": "score on Issue",
            "type": "main",
            "index": 0
          },
          {
            "node": "IF finalize (Issue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "review commit diff",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Skip File Changes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip File Changes": {
      "main": [
        [
          {
            "node": "Parse Last Diff Line",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Last Diff Line": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain1": {
      "main": [
        [
          {
            "node": "Post Discussions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Basic LLM Chain1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "comments on issue": {
      "main": [
        [
          {
            "node": "Get commit diff",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "comments on MR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "comments on MR": {
      "main": [
        [
          {
            "node": "get mr info",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "åˆ¤æ–­æ˜¯ä¸æ˜¯++0 é‡‡ç”¨é«˜çº§æ¨¡åž‹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get commit diff": {
      "main": [
        [
          {
            "node": "filter-large-commit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "filter-large-commit": {
      "main": [
        [
          {
            "node": "review commit diff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR diff": {
      "main": [
        [
          {
            "node": "filter-large-mr",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "review commit diff": {
      "main": [
        [
          {
            "node": "comment on commit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Review MR diff",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "filter-large-mr": {
      "main": [
        [
          {
            "node": "Review MR diff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Review MR diff": {
      "main": [
        [
          {
            "node": "comment on MR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get mr info": {
      "main": [
        [
          {
            "node": "Get MR diff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "filter-large-mr1": {
      "main": [
        [
          {
            "node": "Review MR diff1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR diff1": {
      "main": [
        [
          {
            "node": "filter-large-mr1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Review MR diff1": {
      "main": [
        [
          {
            "node": "comment on MR1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get mr info1": {
      "main": [
        [
          {
            "node": "Get MR diff1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–­æ˜¯ä¸æ˜¯++0 é‡‡ç”¨é«˜çº§æ¨¡åž‹": {
      "main": [
        [
          {
            "node": "get mr info1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Review MR diff1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "commit-lint on MR": {
      "main": [
        [
          {
            "node": "Get MR commits (lint)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set MR context (lint)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR commits (lint)": {
      "main": [
        [
          {
            "node": "Prepare MR commits (lint)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model (Lint MR)": {
      "ai_languageModel": [
        [
          {
            "node": "Commit Lint LLM Chain (MR)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Prepare MR commits (lint)": {
      "main": [
        [
          {
            "node": "Commit Lint LLM Chain (MR)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Commit Lint LLM Chain (MR)": {
      "main": [
        [
          {
            "node": "Guard Lint Output (MR)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set MR context (lint)": {
      "main": [
        [
          {
            "node": "Merge MR lint context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "commit-lint on Issue": {
      "main": [
        [
          {
            "node": "Get related MRs (issue)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set Issue context (lint)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Issue notes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get related MRs (issue)": {
      "main": [
        [
          {
            "node": "Get MR commits (for issue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR commits (for issue)": {
      "main": [
        [
          {
            "node": "Prepare Issue commits (lint)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model (Lint Issue)": {
      "ai_languageModel": [
        [
          {
            "node": "Commit Lint LLM Chain (Issue)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Issue commits (lint)": {
      "main": [
        [
          {
            "node": "Issue Fallback Prepare",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Commit Lint LLM Chain (Issue)": {
      "main": [
        [
          {
            "node": "Guard Lint Output (Issue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Issue context (lint)": {
      "main": [
        [
          {
            "node": "Merge Issue lint context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has MR discussion id": {
      "main": [
        [
          {
            "node": "Post MR lint (reply)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Post MR lint (new discussion)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Issue discussion id": {
      "main": [
        [
          {
            "node": "Post Issue lint (reply)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Post Issue lint (new note)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guard Lint Output (MR)": {
      "main": [
        [
          {
            "node": "Has MR discussion id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guard Lint Output (Issue)": {
      "main": [
        [
          {
            "node": "Has Issue discussion id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Issue notes": {
      "main": [
        [
          {
            "node": "Extract MR from notes",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract commit shas from notes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract MR from notes": {
      "main": [
        [
          {
            "node": "Get MR commits (from notes)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract commit shas from notes": {
      "main": [
        [
          {
            "node": "Get commit detail (sha)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR commits (from notes)": {
      "main": [
        [
          {
            "node": "Prepare Issue commits (lint)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get commit detail (sha)": {
      "main": [
        [
          {
            "node": "Prepare Issue commits (lint)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Issue Fallback Prepare": {
      "main": [
        [
          {
            "node": "Issue has text?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Issue has text?": {
      "main": [
        [
          {
            "node": "Guard Lint Output (Issue)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Commit Lint LLM Chain (Issue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "score on MR": {
      "main": [
        [
          {
            "node": "Set MR context (score)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set MR context (score)": {
      "main": [
        [
          {
            "node": "Get MR notes (score)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR notes (score)": {
      "main": [
        [
          {
            "node": "Debounce MR (score)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debounce MR (score)": {
      "main": [
        [
          {
            "node": "Get MR detail (score)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get MR closes_issues",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get MR commits (score)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get MR changes (score)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get MR notes (context)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR closes_issues": {
      "main": [
        [
          {
            "node": "Pick Issue for MR (score)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pick Issue for MR (score)": {
      "main": [
        [
          {
            "node": "Get Issue detail (score)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Issue detail (score)": {
      "main": [
        [
          {
            "node": "Get Issue notes (score)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR detail (score)": {
      "main": [
        [
          {
            "node": "Build MR score context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR commits (score)": {
      "main": [
        [
          {
            "node": "Build MR score context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR changes (score)": {
      "main": [
        [
          {
            "node": "Build MR score context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR notes (context)": {
      "main": [
        [
          {
            "node": "Build MR score context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Issue notes (score)": {
      "main": [
        [
          {
            "node": "Build MR score context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model (Score)": {
      "ai_languageModel": [
        [
          {
            "node": "Score LLM Chain (MR)",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Score LLM Chain (Issue MR)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Build MR score context": {
      "main": [
        [
          {
            "node": "Score LLM Chain (MR)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Score LLM Chain (MR)": {
      "main": [
        [
          {
            "node": "Parse Score Result (MR)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Score Result (MR)": {
      "main": [
        [
          {
            "node": "Render Score Markdown (MR)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Render Score Markdown (MR)": {
      "main": [
        [
          {
            "node": "Post MR score result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "score on Issue": {
      "main": [
        [
          {
            "node": "Set Issue context (score)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Issue context (score)": {
      "main": [
        [
          {
            "node": "Get Issue notes (score Issue)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Issue notes (debounce)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get related MRs (score Issue API)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Issue discussions (score Issue)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Issue notes (aggregate)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get related MRs (aggregate)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Issue notes (debounce)": {
      "main": [
        [
          {
            "node": "Debounce Issue (score)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set MR ctx (from Issue score)": {
      "main": [
        [
          {
            "node": "Get MR detail (score Issue)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get MR commits (score Issue)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get MR changes (score Issue)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get MR notes (score Issue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR detail (score Issue)": {
      "main": [
        [
          {
            "node": "Build MR score context (Issue)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Issue score context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR commits (score Issue)": {
      "main": [
        [
          {
            "node": "Build MR score context (Issue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR changes (score Issue)": {
      "main": [
        [
          {
            "node": "Build MR score context (Issue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR notes (score Issue)": {
      "main": [
        [
          {
            "node": "Build MR score context (Issue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Issue detail (score Issue)": {
      "main": [
        [
          {
            "node": "Build MR score context (Issue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Issue notes (score Issue)": {
      "main": [
        [
          {
            "node": "Build MR score context (Issue)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Issue score context",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge main score inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build MR score context (Issue)": {
      "main": [
        [
          {
            "node": "Score LLM Chain (Issue MR)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Score LLM Chain (Issue MR)": {
      "main": [
        [
          {
            "node": "Parse Score Result (Issue MR)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get related MRs (score Issue API)": {
      "main": [
        [
          {
            "node": "Map related MRs (score Issue)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge main score inputs",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Map related MRs (score Issue)": {
      "main": [
        [
          {
            "node": "Filter MR items (score Issue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Issue discussions (score Issue)": {
      "main": [
        [
          {
            "node": "Parse discussions mentions (score)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse discussions mentions (score)": {
      "main": [
        [
          {
            "node": "Set commit mentions (issue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Issue score context": {
      "main": [
        [
          {
            "node": "Wait before Aggregate (Issue score)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Issue notes (aggregate)": {
      "main": [
        [
          {
            "node": "Merge aggregate inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get related MRs (aggregate)": {
      "main": [
        [
          {
            "node": "Merge aggregate inputs",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge main score inputs": {
      "main": [
        [
          {
            "node": "Aggregate Issue Score Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter MR items (score Issue)": {
      "main": [
        [
          {
            "node": "Set MR ctx (from Issue score)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Issue Score Summary": {
      "main": [
        [
          {
            "node": "Post Issue score summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}