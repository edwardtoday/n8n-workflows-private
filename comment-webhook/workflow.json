{
  "createdAt": "2025-04-15T09:30:17.133Z",
  "updatedAt": "2025-08-19T06:41:23.000Z",
  "id": "yXqi9J2w2Hn3NR9S",
  "name": "comment-webhook",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "e21095c0-1876-4cd9-9e92-a2eac737f03e",
        "options": {}
      },
      "id": "5237ee9a-3b00-4251-9ef6-800ec920f647",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [
        -1400,
        210
      ],
      "webhookId": "78214945-1731-46ca-a13f-132df9ee1d14",
      "typeVersion": 2
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -380,
        160
      ],
      "id": "6b88ca12-1a93-45ee-9820-d968006b0586",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "XV1sqh2GdIy4Daz1",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "content": "## Edit your own prompt â¬‡ï¸\n"
      },
      "id": "d7503594-cac4-4978-a39b-7718d8e22336",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -500,
        -220
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Replace your gitlab URL and token â¬‡ï¸"
      },
      "id": "665cda3f-54a7-4c8d-978f-991361da6ce6",
      "name": "Sticky Note3",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1100,
        -120
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Replace your gitlab URL and token â¬‡ï¸"
      },
      "id": "7bce12b1-2015-4c5c-bd2d-64fd14a257a5",
      "name": "Sticky Note4",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -200,
        -140
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "fieldToSplitOut": "changes",
        "options": {}
      },
      "id": "0d0c58c3-da61-4b89-81bc-3881c640d4c3",
      "name": "Split Out",
      "type": "n8n-nodes-base.splitOut",
      "position": [
        -760,
        1320
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "c6e1430b-84a7-47ce-8fe9-7b94da0f2d31",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              },
              "leftValue": "={{ $json.renamed_file }}",
              "rightValue": ""
            },
            {
              "id": "bf6e9eb9-d72d-459c-a722-9614bab8842c",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              },
              "leftValue": "={{ $json.deleted_file }}",
              "rightValue": ""
            },
            {
              "id": "501623a9-9515-4034-bb13-a5a6a4f924eb",
              "operator": {
                "type": "string",
                "operation": "startsWith"
              },
              "leftValue": "={{ $json.diff }}",
              "rightValue": "@@"
            }
          ]
        },
        "options": {}
      },
      "id": "323565be-4b32-4773-903b-45f9806c1612",
      "name": "Skip File Changes",
      "type": "n8n-nodes-base.if",
      "position": [
        -540,
        1320
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const parseLastDiff = (gitDiff) => {\n  gitDiff = gitDiff.replace(/\\n\\\\ No newline at end of file/, '')\n  \n  const diffList = gitDiff.trimEnd().split('\\n').reverse();\n  const lastLineFirstChar = diffList?.[0]?.[0];\n  const lastDiff =\n    diffList.find((item) => {\n      return /^@@ \\-\\d+,\\d+ \\+\\d+,\\d+ @@/g.test(item);\n    }) || '';\n\n  const [lastOldLineCount, lastNewLineCount] = lastDiff\n    .replace(/@@ \\-(\\d+),(\\d+) \\+(\\d+),(\\d+) @@.*/g, ($0, $1, $2, $3, $4) => {\n      return `${+$1 + +$2},${+$3 + +$4}`;\n    })\n    .split(',');\n  \n  if (!/^\\d+$/.test(lastOldLineCount) || !/^\\d+$/.test(lastNewLineCount)) {\n    return {\n      lastOldLine: -1,\n      lastNewLine: -1,\n      gitDiff,\n    };\n  }\n\n\n  const lastOldLine = lastLineFirstChar === '+' ? null : (parseInt(lastOldLineCount) || 0) - 1;\n  const lastNewLine = lastLineFirstChar === '-' ? null : (parseInt(lastNewLineCount) || 0) - 1;\n\n  return {\n    lastOldLine,\n    lastNewLine,\n    gitDiff,\n  };\n};\n\nreturn parseLastDiff($input.item.json.diff)\n"
      },
      "id": "808b6017-e4e9-49a5-8c25-2e96b13001c6",
      "name": "Parse Last Diff Line",
      "type": "n8n-nodes-base.code",
      "position": [
        -320,
        1320
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').item.json[\"body\"][\"project_id\"] }}/merge_requests/{{ $('Webhook').item.json[\"body\"][\"merge_request\"][\"iid\"] }}/discussions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $('Basic LLM Chain1').item.json[\"text\"] }}"
            },
            {
              "name": "position[position_type]",
              "value": "text"
            },
            {
              "name": "position[old_path]",
              "value": "={{ $('Split Out').item.json.old_path }}"
            },
            {
              "name": "position[new_path]",
              "value": "={{ $('Split Out').item.json.new_path }}"
            },
            {
              "name": "position[start_sha]",
              "value": "={{ $('Get MR diff').item.json.diff_refs.start_sha }}"
            },
            {
              "name": "position[head_sha]",
              "value": "={{ $('Get MR diff').item.json.diff_refs.head_sha }}"
            },
            {
              "name": "position[base_sha]",
              "value": "={{ $('Get MR diff').item.json.diff_refs.base_sha }}"
            },
            {
              "name": "position[new_line]",
              "value": "={{ $('Parse Last Diff Line').item.json.lastNewLine || ''  }}"
            },
            {
              "name": "position[old_line]",
              "value": "={{ $('Parse Last Diff Line').item.json.lastOldLine || '' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "429f6a04-1026-4322-a5f5-46f64e3b3f13",
      "name": "Post Discussions",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        500,
        1320
      ],
      "typeVersion": 4.2,
      "retryOnFail": true
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=File pathï¼š{{ $('Skip File Changes').item.json.new_path }}\n\n```Original code\n {{ $json.originalCode }}\n```\nchange to\n```New code\n {{ $json.newCode }}\n```\n# Overview:| You are a senior programming expert Bot, responsible for reviewing code changes and providing review recommendations. At the beginning of the suggestion, it is necessary to clearly make a decision to \"reject\" or \"accept\" the code change, and rate the change in the format \"Change Score: Actual Score\", with a score range of 0-100 points. Then, point out the existing problems in concise language and a stern tone. If you feel it is necessary, you can directly provide the modified content. Your review proposal must use rigorous Markdown format and in Simplified Chinese. Start replying with the decision. No need to greet.\\n\\nPlease review the code changes in this section:"
      },
      "id": "6db4fe83-f081-486f-904a-a1de0c69dd54",
      "name": "Basic LLM Chain1",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        120,
        1320
      ],
      "typeVersion": 1.5,
      "retryOnFail": true,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nvar diff = $input.item.json.gitDiff\n\nlet lines = diff.trimEnd().split('\\n');\n\nlet originalCode = '';\nlet newCode = '';\n\nlines.forEach(line => {\n  console.log(line)\n    if (line.startsWith('-')) {\n        originalCode += line + \"\\n\";\n    } else if (line.startsWith('+')) {\n        newCode += line + \"\\n\";\n    } else {\n        originalCode += line + \"\\n\";\n        newCode += line + \"\\n\";\n    }\n});\n\nreturn {\n  originalCode:originalCode,\n  newCode:newCode\n};\n\n"
      },
      "id": "e690f91d-f9cd-4943-8907-69532bfc87a6",
      "name": "Code1",
      "type": "n8n-nodes-base.code",
      "position": [
        -100,
        1320
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        260,
        1500
      ],
      "id": "6e88bc74-e100-47d9-b125-6a4c8a468cbd",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "XV1sqh2GdIy4Daz1",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9ae1fca0-0229-4de2-9b79-aacca6d1e095",
              "leftValue": "={{ $json.body.object_attributes.noteable_type }}",
              "rightValue": "Commit",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "3fa54747-e3ac-459f-b923-a04769848835",
              "leftValue": "={{ $json.body.object_attributes.note }}",
              "rightValue": "+0",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1180,
        220
      ],
      "id": "66295c86-290c-4c24-93d9-5694ba72548a",
      "name": "comments on issue"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "d57173d7-253c-406f-8a7b-564bc1804dd3",
              "leftValue": "={{ $json.body.object_attributes.noteable_type }}",
              "rightValue": "MergeRequest",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "617eb2c5-dd4b-4e28-b533-0c32ea6ca961",
              "operator": {
                "name": "filter.operator.equals",
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "={{ $json.body.object_attributes.note }}",
              "rightValue": "+0"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d73eb7a2-3f42-4e51-a73a-edeab093d4ff",
      "name": "comments on MR",
      "type": "n8n-nodes-base.if",
      "position": [
        -960,
        360
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $json.body.project.id }}/repository/commits/{{ $json.body.object_attributes.commit_id }}/diff ",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        60
      ],
      "id": "56441e49-e7a9-43de-99fd-bb06f13a09ff",
      "name": "Get commit diff"
    },
    {
      "parameters": {
        "jsCode": "// --- é…ç½®å‚æ•° ---\nconst MAX_FILES_FOR_LARGE_COMMIT = 20; // è¶…è¿‡è¿™ä¸ªæ•°é‡çš„æ–‡ä»¶ï¼Œè§†ä¸ºå¤§æäº¤\nconst MAX_FILES_TO_PROCESS_IF_LARGE = 10; // å¦‚æœæ˜¯å¤§æäº¤ï¼Œå®é™…å¤„ç†çš„æ–‡ä»¶ä¸Šé™ (ä»è¡Œæ•°è¿‡æ»¤åçš„ç»“æœä¸­é€‰å–)\nconst MAX_DIFF_LINES_PER_FILE = 1000; // å•ä¸ªæ–‡ä»¶ diff çš„æœ€å¤§è¡Œæ•°ï¼Œè¶…è¿‡åˆ™è·³è¿‡\n\n// --- è·å–æ‰€æœ‰è¾“å…¥ item ---\nconst allN8nInputItems = $input.all();\nconst originalFileCount = allN8nInputItems.length;\n\n// --- æ­¥éª¤ 1: è¿‡æ»¤æ‰ diff è¡Œæ•°è¿‡å¤šçš„æ–‡ä»¶ ---\n// itemsWithinLineLimit å°†åŒ…å«ç¬¦åˆè¡Œæ•°é™åˆ¶çš„ n8n item å¯¹è±¡\nconst itemsWithinLineLimit = allN8nInputItems.filter(item => {\n  if (item.json && typeof item.json.diff === 'string') {\n    const lineCount = item.json.diff.split('\\n').length;\n    if (lineCount > MAX_DIFF_LINES_PER_FILE) {\n      console.log(`æ–‡ä»¶ \"${item.json.new_path || 'æœªçŸ¥è·¯å¾„'}\" diff è¡Œæ•° (${lineCount}) è¿‡å¤šï¼Œå·²è·³è¿‡ã€‚`);\n      return false;\n    }\n    return true;\n  }\n  console.log(`æ–‡ä»¶ \"${(item.json && item.json.new_path) || 'æœªçŸ¥è·¯å¾„'}\" çš„ diff æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡ã€‚`);\n  return false;\n});\n\nconst filesAfterLineFilterCount = itemsWithinLineLimit.length;\n\n// --- æ­¥éª¤ 2: æ ¹æ®åŸå§‹æ–‡ä»¶æ•°é‡åˆ¤æ–­æ˜¯å¦ä¸ºå¤§æäº¤ï¼Œå¹¶å†³å®šæœ€ç»ˆå¤„ç†å“ªäº›æ–‡ä»¶ ---\nlet isLargeCommit = originalFileCount > MAX_FILES_FOR_LARGE_COMMIT;\nlet wholediffArrayOfN8nItems; // è¿™ä¸ªå˜é‡å°†æŒæœ‰ n8n item å¯¹è±¡çš„æ•°ç»„\n\nif (isLargeCommit) {\n  // å¦‚æœåŸå§‹æ–‡ä»¶æ•°å®šä¹‰ä¸ºå¤§æäº¤ï¼Œåˆ™ä»â€œè¡Œæ•°è¿‡æ»¤åçš„æ–‡ä»¶â€ä¸­å–å‰ MAX_FILES_TO_PROCESS_IF_LARGE ä¸ª\n  wholediffArrayOfN8nItems = itemsWithinLineLimit.slice(0, MAX_FILES_TO_PROCESS_IF_LARGE);\n  console.log(`åŸå§‹æäº¤åŒ…å« ${originalFileCount} ä¸ªæ–‡ä»¶ (å¤§æäº¤)ã€‚è¡Œæ•°è¿‡æ»¤åå‰©ä½™ ${filesAfterLineFilterCount} ä¸ªæ–‡ä»¶ã€‚å°†å¤„ç†å‰ ${wholediffArrayOfN8nItems.length} ä¸ªæ–‡ä»¶ã€‚`);\n  return {\n    largecommit: true,\n    wholediff: wholediffArrayOfN8nItems // ç›´æ¥è¿”å› n8n item å¯¹è±¡çš„æ•°ç»„\n  };\n} else {\n  // å¦‚æœä¸æ˜¯å¤§æäº¤ï¼Œåˆ™å¤„ç†æ‰€æœ‰â€œè¡Œæ•°è¿‡æ»¤åçš„æ–‡ä»¶â€\n  wholediffArrayOfN8nItems = itemsWithinLineLimit;\n  console.log(`åŸå§‹æäº¤åŒ…å« ${originalFileCount} ä¸ªæ–‡ä»¶ã€‚è¡Œæ•°è¿‡æ»¤åå‰©ä½™ ${filesAfterLineFilterCount} ä¸ªæ–‡ä»¶ã€‚å°†å¤„ç†æ‰€æœ‰ ${wholediffArrayOfN8nItems.length} ä¸ªæ–‡ä»¶ã€‚`);\n  return {\n    largecommit: false,\n    wholediff: wholediffArrayOfN8nItems // ç›´æ¥è¿”å› n8n item å¯¹è±¡çš„æ•°ç»„\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -740,
        60
      ],
      "id": "d27da464-c32b-45e8-8388-9966becd72a5",
      "name": "filter-large-commit"
    },
    {
      "parameters": {
        "jsCode": "// --- é…ç½®å‚æ•° ---\nconst MAX_FILES_FOR_LARGE_MERGE_REQUEST = 100; // è¶…è¿‡è¿™ä¸ªæ•°é‡çš„æ–‡ä»¶ï¼Œè§†ä¸ºå¤§MR\nconst MAX_FILES_TO_PROCESS_IF_LARGE = 100; // å¦‚æœæ˜¯å¤§MRï¼Œå®é™…å¤„ç†çš„æ–‡ä»¶ä¸Šé™ (ä»è¡Œæ•°è¿‡æ»¤åçš„ç»“æœä¸­é€‰å–)\nconst MAX_DIFF_LINES_PER_FILE = 1000; // å•ä¸ªæ–‡ä»¶ diff çš„æœ€å¤§è¡Œæ•°ï¼Œè¶…è¿‡åˆ™è·³è¿‡\n\n// --- è·å–æ‰€æœ‰è¾“å…¥ item ---\nconst allN8nInputItems = $input.first().json.changes;\nconst originalFileCount = allN8nInputItems.length;\n\n// --- æ­¥éª¤ 1: è¿‡æ»¤æ‰ diff è¡Œæ•°è¿‡å¤šçš„æ–‡ä»¶ ---\n// itemsWithinLineLimit å°†åŒ…å«ç¬¦åˆè¡Œæ•°é™åˆ¶çš„ n8n item å¯¹è±¡\nconst itemsWithinLineLimit = allN8nInputItems.filter(item => {\n  if (item.diff && typeof item.diff === 'string') {\n    const lineCount = item.diff.split('\\n').length;\n    if (lineCount > MAX_DIFF_LINES_PER_FILE) {\n      console.log(`æ–‡ä»¶ \"${item.new_path || 'æœªçŸ¥è·¯å¾„'}\" diff è¡Œæ•° (${lineCount}) è¿‡å¤šï¼Œå·²è·³è¿‡ã€‚`);\n      return false;\n    }\n    return true;\n  }\n  console.log(`æ–‡ä»¶ \"${(item.diff && item.new_path) || 'æœªçŸ¥è·¯å¾„'}\" çš„ diff æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡ã€‚`);\n  return false;\n});\n\nconst filesAfterLineFilterCount = itemsWithinLineLimit.length;\n\n// --- æ­¥éª¤ 2: æ ¹æ®åŸå§‹æ–‡ä»¶æ•°é‡åˆ¤æ–­æ˜¯å¦ä¸ºå¤§MRï¼Œå¹¶å†³å®šæœ€ç»ˆå¤„ç†å“ªäº›æ–‡ä»¶ ---\nlet isLargeMR = originalFileCount > MAX_FILES_FOR_LARGE_MERGE_REQUEST;\nlet wholediffArrayOfN8nItems; // è¿™ä¸ªå˜é‡å°†æŒæœ‰ n8n item å¯¹è±¡çš„æ•°ç»„\n\nif (isLargeMR) {\n  // å¦‚æœåŸå§‹æ–‡ä»¶æ•°å®šä¹‰ä¸ºå¤§MRï¼Œåˆ™ä»â€œè¡Œæ•°è¿‡æ»¤åçš„æ–‡ä»¶â€ä¸­å–å‰ MAX_FILES_TO_PROCESS_IF_LARGE ä¸ª\n  wholediffArrayOfN8nItems = itemsWithinLineLimit.slice(0, MAX_FILES_TO_PROCESS_IF_LARGE);\n  console.log(`åŸå§‹MRåŒ…å« ${originalFileCount} ä¸ªæ–‡ä»¶ (å¤§MR)ã€‚è¡Œæ•°è¿‡æ»¤åå‰©ä½™ ${filesAfterLineFilterCount} ä¸ªæ–‡ä»¶ã€‚å°†å¤„ç†å‰ ${wholediffArrayOfN8nItems.length} ä¸ªæ–‡ä»¶ã€‚`);\n  return {\n    largecommit: true,\n    wholediff: wholediffArrayOfN8nItems // ç›´æ¥è¿”å› n8n item å¯¹è±¡çš„æ•°ç»„\n  };\n} else {\n  // å¦‚æœä¸æ˜¯å¤§MRï¼Œåˆ™å¤„ç†æ‰€æœ‰â€œè¡Œæ•°è¿‡æ»¤åçš„æ–‡ä»¶â€\n  wholediffArrayOfN8nItems = itemsWithinLineLimit;\n  console.log(`åŸå§‹MRåŒ…å« ${originalFileCount} ä¸ªæ–‡ä»¶ã€‚è¡Œæ•°è¿‡æ»¤åå‰©ä½™ ${filesAfterLineFilterCount} ä¸ªæ–‡ä»¶ã€‚å°†å¤„ç†æ‰€æœ‰ ${wholediffArrayOfN8nItems.length} ä¸ªæ–‡ä»¶ã€‚`);\n  return {\n    largecommit: false,\n    wholediff: wholediffArrayOfN8nItems // ç›´æ¥è¿”å› n8n item å¯¹è±¡çš„æ•°ç»„\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -144,
        360
      ],
      "id": "ee222b16-fa76-40a3-9ac1-ab0e1e06af71",
      "name": "filter-large-mr"
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').item.json.body.project.id }}/merge_requests/{{ $('Webhook').item.json.body.merge_request.iid }}/changes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "abdc0e15-c830-4b17-80f0-e862bdfdca0a",
      "name": "Get MR diff",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -442,
        360
      ],
      "typeVersion": 4.2,
      "retryOnFail": true,
      "waitBetweenTries": 3000
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# æ¦‚è¿°:| æ‚¨æ˜¯ä¸€ä½èµ„æ·±çš„ç¼–ç¨‹ä¸“å®¶ï¼Œè´Ÿè´£å®¡æŸ¥ä»£ç å˜æ›´å¹¶æä¾›è¯„å®¡å»ºè®®ã€‚æ‚¨çš„ç›®æ ‡æ˜¯å¸®åŠ©å¼€å‘è€…æ”¹è¿›ä»£ç è´¨é‡ã€‚\n\n**æ ¸å¿ƒè¦æ±‚:**\n1.  **å†³ç­–ä¸è¯„åˆ†**: åœ¨å»ºè®®çš„å¼€å¤´ï¼Œæ˜ç¡®å¯¹æ•´ä¸ªä»£ç æäº¤ï¼ˆCommitï¼‰åšå‡ºâ€œæ‹’ç»â€æˆ–â€œæ¥å—â€ ğŸ‘ğŸ‘ çš„å†³å®šï¼Œå¹¶ä»¥â€œå˜æ›´è¯„åˆ†ï¼šå®é™…å¾—åˆ†/100â€çš„æ ¼å¼å¯¹æœ¬æ¬¡æäº¤è¿›è¡Œè¯„åˆ†ã€‚\n2.  **è¯„å®¡é£æ ¼**: ä»¥ç®€æ´ã€ä¸“ä¸šä¸”å…·æœ‰å»ºè®¾æ€§çš„å£å»æŒ‡å‡ºé—®é¢˜ã€‚å¦‚æœå†³å®šæ¥å—ï¼Œä¸ç”¨è¿‡å¤šç‚¹è¯„ï¼Œè¡¨ç¤ºé¼“åŠ±å³å¯ï¼›å¦‚æœå†³å®šæ‹’ç»ï¼Œæ‰éœ€è¦æŒ‡å‡ºé—®é¢˜ã€‚\n3.  **ä»£ç ä¿®æ”¹å»ºè®®**:\n    *   **ç®€æ´è‡³ä¸Š**: å½“æŒ‡å‡ºä»£ç é—®é¢˜æ—¶ï¼Œ**ä»…æä¾›å¿…è¦çš„åŸå§‹ä»£ç ç‰‡æ®µå’Œå¯¹åº”çš„ä¿®æ”¹å»ºè®®ç‰‡æ®µ**ã€‚é¿å…è¿”å›å¤§æ®µæœªç»ä¿®æ”¹æˆ–ä¸é—®é¢˜ä¸ç›´æ¥ç›¸å…³çš„ä»£ç ã€‚ä¸“æ³¨äºâ€œå¦‚ä½•æ”¹â€çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚\n    *   ä¾‹å¦‚ï¼Œå¦‚æœä¸€è¡Œä»£ç éœ€è¦ä¿®æ”¹ï¼Œå¯ä»¥å±•ç¤ºï¼š\n        ```diff\n        - é—®é¢˜ä»£ç è¡Œ\n        + å»ºè®®ä¿®æ”¹åçš„ä»£ç è¡Œ\n        ```\n        æˆ–è€…ç”¨æ–‡å­—æè¿°é…åˆå°‘é‡ä¸Šä¸‹æ–‡ä»£ç ã€‚\n4.  **æ ¼å¼**:\n    *   æ‚¨çš„è¯„å®¡å»ºè®®å¿…é¡»ä½¿ç”¨ä¸¥è°¨çš„ **GitLab Flavored Markdown (GFM)** æ ¼å¼å‘ˆç°ï¼Œä»¥ä¾¿ç›´æ¥ç”¨äº GitLab çš„è¯„è®ºåŒºã€‚æ‚¨å¯ä»¥é…Œæƒ…ä½¿ç”¨ GFM çš„ç‰¹æ€§ï¼Œå¦‚ä»»åŠ¡åˆ—è¡¨ (`- [ ]`)ã€ä»£ç é«˜äº®ã€å¼•ç”¨ç­‰ã€‚\n    *   è¾“å‡ºè¯­è¨€ä¸º**ç®€ä½“ä¸­æ–‡**ã€‚\n5.  **è¡¨è¾¾**:\n    *   åœ¨é€‚å½“çš„åœ°æ–¹ï¼ˆä¾‹å¦‚ï¼Œæ€»ç»“ã€èµæ‰¬æˆ–æŒ‡å‡ºä¸¥é‡é—®é¢˜æ—¶ï¼‰å¯ä»¥ä½¿ç”¨ Emoji âœ¨ğŸ’¡âš ï¸æ¥å¢å¼ºè¡¨è¾¾æ•ˆæœï¼Œä½†ä¸è¦è¿‡åº¦ä½¿ç”¨ã€‚\n    *   å¦‚æœå­˜åœ¨ä¸æ‚¨æŒ‡å‡ºçš„é—®é¢˜ç›¸å…³çš„ã€æ™®éè®¤å¯çš„å…¬å…±æ–‡æ¡£ï¼ˆå¦‚å®˜æ–¹è¯­è¨€/æ¡†æ¶æ–‡æ¡£ã€çŸ¥åæŠ€æœ¯åšå®¢çš„æœ€ä½³å®è·µæ–‡ç« ï¼‰ï¼Œæ‚¨å¯ä»¥é…Œæƒ…æä¾›å‚è€ƒé“¾æ¥ğŸ”—ã€‚è¯·ç¡®ä¿é“¾æ¥æŒ‡å‘çš„æ˜¯å¹¿æ³›å¯ä¿¡çš„èµ„æºã€‚\n\n**ä»»åŠ¡:**\nè¯·ç»¼åˆå®¡æŸ¥ä»¥ä¸‹å±äºåŒä¸€æ¬¡ä»£ç æäº¤ï¼ˆCommitï¼‰çš„æ‰€æœ‰æ–‡ä»¶å˜æ›´ã€‚æ‚¨éœ€è¦ä»”ç»†åˆ†æå„ä¸ªæ–‡ä»¶å˜æ›´ä¹‹é—´çš„æ½œåœ¨å…³è”å’Œç›¸äº’å½±å“ï¼Œå¹¶å¯¹æ•´ä¸ªæäº¤ï¼ˆCommitï¼‰æä¾›ä¸€ä¸ªæ•´ä½“æ€§çš„ã€ç»Ÿä¸€çš„è¯„å®¡æ„è§ã€‚è¯·ä»å¯¹æ•´ä¸ªæäº¤çš„å†³å®šå¼€å§‹å›å¤ï¼Œæ— éœ€å¯’æš„ã€‚\n\nå¦‚æœè¿™ä¸ª commit è¶…è¿‡ 20 ä¸ª diffï¼Œlargecommit å°†ä¸º trueã€‚è¯·ä½ åœ¨è¯„è®ºå¼€å¤´å°±è¡¨æ˜\"âš ï¸ è¿™æ˜¯ä¸€ä¸ªå¤§å‹æäº¤ã€‚ä¸ºæé«˜æ•ˆç‡ï¼Œå·²å¯¹å˜æ›´æ–‡ä»¶åˆ†æè¿›è¡Œäº†æ•°é‡é™åˆ¶ã€‚\"ã€‚å¦åˆ™ä¸ç”¨æåŠ largecommit ç›¸å…³å†…å®¹ã€‚\n\nlargecommmit: {{ $json.largecommit }}\n\næœ¬æ¬¡ commit message æ˜¯\n\n```\n{{ $('Webhook').first().json.body.commit.message }}\n```\n\nè¿™æ˜¯ gitlab api å¾—åˆ°çš„ commit diff\n\n```json\n{{ $json.wholediff.toJsonString() }}\n```\n\nå¯¹æ•´ä¸ªæäº¤çš„ç»¼åˆè¯„å®¡æ„è§:"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        -520,
        -40
      ],
      "id": "ccf5a720-0136-4cb7-8a09-1eb0ade0d98c",
      "name": "review commit diff",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-flash",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        240,
        540
      ],
      "id": "d437d36b-8e70-4241-90aa-b8b50838a59a",
      "name": "OpenRouter Chat Model2",
      "credentials": {
        "openRouterApi": {
          "id": "XV1sqh2GdIy4Daz1",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# æ¦‚è¿°:| æ‚¨æ˜¯ä¸€ä½èµ„æ·±çš„ç¼–ç¨‹ä¸“å®¶ï¼Œè´Ÿè´£å®¡æŸ¥ä»£ç å˜æ›´å¹¶æä¾›è¯„å®¡å»ºè®®ã€‚æ‚¨çš„ç›®æ ‡æ˜¯å¸®åŠ©å¼€å‘è€…æ”¹è¿›ä»£ç è´¨é‡ã€‚\n\n**æ ¸å¿ƒè¦æ±‚:**\n1.  **å†³ç­–ä¸è¯„åˆ†**: åœ¨å»ºè®®çš„å¼€å¤´ï¼Œæ˜ç¡®å¯¹æ•´ä¸ªä»£ç åˆå¹¶ï¼ˆMerge Requestï¼‰åšå‡ºâ€œæ‹’ç»â€æˆ–â€œæ¥å—â€ ğŸ‘ğŸ‘ çš„å†³å®šï¼Œå¹¶ä»¥â€œå˜æ›´è¯„åˆ†ï¼šå®é™…å¾—åˆ†/100â€çš„æ ¼å¼å¯¹æœ¬æ¬¡MRè¿›è¡Œè¯„åˆ†ã€‚\n2.  **è¯„å®¡é£æ ¼**: ä»¥ç®€æ´ã€ä¸“ä¸šä¸”å…·æœ‰å»ºè®¾æ€§çš„å£å»æŒ‡å‡ºé—®é¢˜ã€‚å¦‚æœå†³å®šæ¥å—ï¼Œä¸ç”¨è¿‡å¤šç‚¹è¯„ï¼Œè¡¨ç¤ºé¼“åŠ±å³å¯ï¼›å¦‚æœå†³å®šæ‹’ç»ï¼Œæ‰éœ€è¦æŒ‡å‡ºé—®é¢˜ã€‚\n3.  **ä»£ç ä¿®æ”¹å»ºè®®**:\n    *   **ç®€æ´è‡³ä¸Š**: å½“æŒ‡å‡ºä»£ç é—®é¢˜æ—¶ï¼Œ**ä»…æä¾›å¿…è¦çš„åŸå§‹ä»£ç ç‰‡æ®µå’Œå¯¹åº”çš„ä¿®æ”¹å»ºè®®ç‰‡æ®µ**ã€‚é¿å…è¿”å›å¤§æ®µæœªç»ä¿®æ”¹æˆ–ä¸é—®é¢˜ä¸ç›´æ¥ç›¸å…³çš„ä»£ç ã€‚ä¸“æ³¨äºâ€œå¦‚ä½•æ”¹â€çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚\n    *   ä¾‹å¦‚ï¼Œå¦‚æœä¸€è¡Œä»£ç éœ€è¦ä¿®æ”¹ï¼Œå¯ä»¥å…ˆåå±•ç¤ºé—®é¢˜ä»£ç å—å’Œå»ºè®®ä¿®æ”¹åçš„ä»£ç è¡Œ(æ ‡æ˜è¯­è¨€ï¼Œä»¥ä»¤ markdown æ¸²æŸ“æ—¶èƒ½æ­£ç¡®é«˜äº®ï¼‰ï¼Œæˆ–è€…ç”¨æ–‡å­—æè¿°é…åˆå°‘é‡ä¸Šä¸‹æ–‡ä»£ç ã€‚\n4.  **æ ¼å¼**:\n    *   æ‚¨çš„è¯„å®¡å»ºè®®å¿…é¡»ä½¿ç”¨ä¸¥è°¨çš„ **GitLab Flavored Markdown (GFM)** æ ¼å¼å‘ˆç°ï¼Œä»¥ä¾¿ç›´æ¥ç”¨äº GitLab çš„è¯„è®ºåŒºã€‚æ‚¨å¯ä»¥é…Œæƒ…ä½¿ç”¨ GFM çš„ç‰¹æ€§ï¼Œå¦‚ä»»åŠ¡åˆ—è¡¨ (`- [ ]`)ã€ä»£ç é«˜äº®ã€å¼•ç”¨ç­‰ã€‚\n    *   è¾“å‡ºè¯­è¨€ä¸º**ç®€ä½“ä¸­æ–‡**ã€‚\n5.  **è¡¨è¾¾**:\n    *   åœ¨é€‚å½“çš„åœ°æ–¹ï¼ˆä¾‹å¦‚ï¼Œæ€»ç»“ã€èµæ‰¬æˆ–æŒ‡å‡ºä¸¥é‡é—®é¢˜æ—¶ï¼‰å¯ä»¥ä½¿ç”¨ Emoji âœ¨ğŸ’¡âš ï¸æ¥å¢å¼ºè¡¨è¾¾æ•ˆæœï¼Œä½†ä¸è¦è¿‡åº¦ä½¿ç”¨ã€‚\n    *   å¦‚æœå­˜åœ¨ä¸æ‚¨æŒ‡å‡ºçš„é—®é¢˜ç›¸å…³çš„ã€æ™®éè®¤å¯çš„å…¬å…±æ–‡æ¡£ï¼ˆå¦‚å®˜æ–¹è¯­è¨€/æ¡†æ¶æ–‡æ¡£ã€çŸ¥åæŠ€æœ¯åšå®¢çš„æœ€ä½³å®è·µæ–‡ç« ï¼‰ï¼Œæ‚¨å¯ä»¥é…Œæƒ…æä¾›å‚è€ƒé“¾æ¥ğŸ”—ã€‚è¯·ç¡®ä¿é“¾æ¥æŒ‡å‘çš„æ˜¯å¹¿æ³›å¯ä¿¡çš„èµ„æºã€‚\n\n**ä»»åŠ¡:**\nè¯·ç»¼åˆå®¡æŸ¥ä»¥ä¸‹å±äºåŒä¸€æ¬¡ä»£ç MRçš„æ‰€æœ‰æ–‡ä»¶å˜æ›´ã€‚æ‚¨éœ€è¦ä»”ç»†åˆ†æå„ä¸ªæ–‡ä»¶å˜æ›´ä¹‹é—´çš„æ½œåœ¨å…³è”å’Œç›¸äº’å½±å“ï¼Œå¹¶å¯¹æ•´ä¸ªMRæä¾›ä¸€ä¸ªæ•´ä½“æ€§çš„ã€ç»Ÿä¸€çš„è¯„å®¡æ„è§ã€‚è¯·ä»å¯¹æ•´ä¸ªMRçš„å†³å®šå¼€å§‹å›å¤ï¼Œæ— éœ€å¯’æš„ã€‚\n\nå¦‚æœè¿™ä¸ªMRè¶…è¿‡ 20 ä¸ª diffï¼Œlargecommit å°†ä¸º trueã€‚è¯·ä½ åœ¨è¯„è®ºå¼€å¤´å°±è¡¨æ˜\"âš ï¸ è¿™æ˜¯ä¸€ä¸ªå¤§å‹MRã€‚ä¸ºæé«˜æ•ˆç‡ï¼Œå·²å¯¹å˜æ›´æ–‡ä»¶çš„åˆ†æè¿›è¡Œäº†æ•°é‡é™åˆ¶ã€‚\"ã€‚å¦åˆ™ä¸ç”¨æåŠ largecommit ç›¸å…³å†…å®¹ã€‚\n\nlargecommmit: {{ $json.largecommit }}\n\næœ¬æ¬¡ MR æ ‡é¢˜æ˜¯\n\n```\n{{ $('Webhook').first().json.body.merge_request.title }}\n```\n\næœ¬æ¬¡ MR æ­£æ–‡æ˜¯\n\n```\n{{ $('Webhook').first().json.body.merge_request.description }}\n```\n\nè¿™æ˜¯ gitlab api å¾—åˆ°çš„ commit diff\n\n```json\n{{ $json.wholediff.toJsonString() }}\n```\n\nå¯¹æ•´ä¸ªMRçš„ç»¼åˆè¯„å®¡æ„è§:"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        76,
        360
      ],
      "id": "b7decd20-9db6-46a3-a3c4-3d62ce9b0cb1",
      "name": "Review MR diff",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project.id }}/repository/commits/{{ $('Webhook').first().json.body.commit.id }}/comments\n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "note",
              "value": "={{ $('review commit diff').item.json[\"text\"] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -144,
        60
      ],
      "id": "52b21432-c690-4d6d-ac2a-950ae7f77436",
      "name": "comment on commit",
      "retryOnFail": true,
      "waitBetweenTries": 3000
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/merge_requests/{{ $('Webhook').first().json.body.merge_request.iid }}/discussions/{{ $('Webhook').first().json.body.object_attributes.discussion_id }}/notes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "d567ef91-bd15-4812-a26f-7d4fb989cbe5",
      "name": "comment on MR",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        452,
        360
      ],
      "typeVersion": 4.2,
      "retryOnFail": true
    },
    {
      "parameters": {
        "content": "## åŸåšæ³•ï¼šå¯¹æ¯ä¸ª diff åŠ  discussion",
        "height": 380,
        "width": 1560
      },
      "id": "fb198b2e-7c37-4f5a-9a65-750bb63fd20a",
      "name": "Sticky Note5",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -820,
        1240
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## æ–°åšæ³•ï¼šæ•´ä¸ª MR ä¸€èµ·è¯„ä»·ï¼ŒåŠ  note (comment)",
        "height": 360,
        "width": 1480
      },
      "id": "74bdb4c2-ba11-4e22-bfcd-1d1f2ba1c52a",
      "name": "Sticky Note6",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -800,
        320
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').item.json.body.project.id }}/merge_requests/{{ $('Webhook').item.json.body.object_attributes.iid }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "d4660dd6-5e92-453a-817e-01f7b9553a96",
      "name": "get mr info",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -740,
        360
      ],
      "typeVersion": 4.2,
      "retryOnFail": true,
      "waitBetweenTries": 3000
    },
    {
      "parameters": {
        "jsCode": "// --- é…ç½®å‚æ•° ---\nconst MAX_FILES_FOR_LARGE_MERGE_REQUEST = 100; // è¶…è¿‡è¿™ä¸ªæ•°é‡çš„æ–‡ä»¶ï¼Œè§†ä¸ºå¤§MR\nconst MAX_FILES_TO_PROCESS_IF_LARGE = 100; // å¦‚æœæ˜¯å¤§MRï¼Œå®é™…å¤„ç†çš„æ–‡ä»¶ä¸Šé™ (ä»è¡Œæ•°è¿‡æ»¤åçš„ç»“æœä¸­é€‰å–)\nconst MAX_DIFF_LINES_PER_FILE = 1000; // å•ä¸ªæ–‡ä»¶ diff çš„æœ€å¤§è¡Œæ•°ï¼Œè¶…è¿‡åˆ™è·³è¿‡\n\n// --- è·å–æ‰€æœ‰è¾“å…¥ item ---\nconst allN8nInputItems = $input.first().json.changes;\nconst originalFileCount = allN8nInputItems.length;\n\n// --- æ­¥éª¤ 1: è¿‡æ»¤æ‰ diff è¡Œæ•°è¿‡å¤šçš„æ–‡ä»¶ ---\n// itemsWithinLineLimit å°†åŒ…å«ç¬¦åˆè¡Œæ•°é™åˆ¶çš„ n8n item å¯¹è±¡\nconst itemsWithinLineLimit = allN8nInputItems.filter(item => {\n  if (item.diff && typeof item.diff === 'string') {\n    const lineCount = item.diff.split('\\n').length;\n    if (lineCount > MAX_DIFF_LINES_PER_FILE) {\n      console.log(`æ–‡ä»¶ \"${item.new_path || 'æœªçŸ¥è·¯å¾„'}\" diff è¡Œæ•° (${lineCount}) è¿‡å¤šï¼Œå·²è·³è¿‡ã€‚`);\n      return false;\n    }\n    return true;\n  }\n  console.log(`æ–‡ä»¶ \"${(item.diff && item.new_path) || 'æœªçŸ¥è·¯å¾„'}\" çš„ diff æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡ã€‚`);\n  return false;\n});\n\nconst filesAfterLineFilterCount = itemsWithinLineLimit.length;\n\n// --- æ­¥éª¤ 2: æ ¹æ®åŸå§‹æ–‡ä»¶æ•°é‡åˆ¤æ–­æ˜¯å¦ä¸ºå¤§MRï¼Œå¹¶å†³å®šæœ€ç»ˆå¤„ç†å“ªäº›æ–‡ä»¶ ---\nlet isLargeMR = originalFileCount > MAX_FILES_FOR_LARGE_MERGE_REQUEST;\nlet wholediffArrayOfN8nItems; // è¿™ä¸ªå˜é‡å°†æŒæœ‰ n8n item å¯¹è±¡çš„æ•°ç»„\n\nif (isLargeMR) {\n  // å¦‚æœåŸå§‹æ–‡ä»¶æ•°å®šä¹‰ä¸ºå¤§MRï¼Œåˆ™ä»â€œè¡Œæ•°è¿‡æ»¤åçš„æ–‡ä»¶â€ä¸­å–å‰ MAX_FILES_TO_PROCESS_IF_LARGE ä¸ª\n  wholediffArrayOfN8nItems = itemsWithinLineLimit.slice(0, MAX_FILES_TO_PROCESS_IF_LARGE);\n  console.log(`åŸå§‹MRåŒ…å« ${originalFileCount} ä¸ªæ–‡ä»¶ (å¤§MR)ã€‚è¡Œæ•°è¿‡æ»¤åå‰©ä½™ ${filesAfterLineFilterCount} ä¸ªæ–‡ä»¶ã€‚å°†å¤„ç†å‰ ${wholediffArrayOfN8nItems.length} ä¸ªæ–‡ä»¶ã€‚`);\n  return {\n    largecommit: true,\n    wholediff: wholediffArrayOfN8nItems // ç›´æ¥è¿”å› n8n item å¯¹è±¡çš„æ•°ç»„\n  };\n} else {\n  // å¦‚æœä¸æ˜¯å¤§MRï¼Œåˆ™å¤„ç†æ‰€æœ‰â€œè¡Œæ•°è¿‡æ»¤åçš„æ–‡ä»¶â€\n  wholediffArrayOfN8nItems = itemsWithinLineLimit;\n  console.log(`åŸå§‹MRåŒ…å« ${originalFileCount} ä¸ªæ–‡ä»¶ã€‚è¡Œæ•°è¿‡æ»¤åå‰©ä½™ ${filesAfterLineFilterCount} ä¸ªæ–‡ä»¶ã€‚å°†å¤„ç†æ‰€æœ‰ ${wholediffArrayOfN8nItems.length} ä¸ªæ–‡ä»¶ã€‚`);\n  return {\n    largecommit: false,\n    wholediff: wholediffArrayOfN8nItems // ç›´æ¥è¿”å› n8n item å¯¹è±¡çš„æ•°ç»„\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -180,
        780
      ],
      "id": "a5ae0b6d-e649-4c13-9759-34fd128cfee3",
      "name": "filter-large-mr1"
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').item.json.body.project.id }}/merge_requests/{{ $('Webhook').item.json.body.merge_request.iid }}/changes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "28de0dbd-1b3d-4af0-9fc5-5f1edfdefa99",
      "name": "Get MR diff1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -480,
        780
      ],
      "typeVersion": 4.2,
      "retryOnFail": true,
      "waitBetweenTries": 3000
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# æ¦‚è¿°:| æ‚¨æ˜¯ä¸€ä½èµ„æ·±çš„ç¼–ç¨‹ä¸“å®¶ï¼Œè´Ÿè´£å®¡æŸ¥ä»£ç å˜æ›´å¹¶æä¾›è¯„å®¡å»ºè®®ã€‚æ‚¨çš„ç›®æ ‡æ˜¯å¸®åŠ©å¼€å‘è€…æ”¹è¿›ä»£ç è´¨é‡ã€‚\n\n**æ ¸å¿ƒè¦æ±‚:**\n1.  **å†³ç­–ä¸è¯„åˆ†**: åœ¨å»ºè®®çš„å¼€å¤´ï¼Œæ˜ç¡®å¯¹æ•´ä¸ªä»£ç åˆå¹¶ï¼ˆMerge Requestï¼‰åšå‡ºâ€œæ‹’ç»â€æˆ–â€œæ¥å—â€ ğŸ‘ğŸ‘ çš„å†³å®šï¼Œå¹¶ä»¥â€œå˜æ›´è¯„åˆ†ï¼šå®é™…å¾—åˆ†/100â€çš„æ ¼å¼å¯¹æœ¬æ¬¡MRè¿›è¡Œè¯„åˆ†ã€‚\n2.  **è¯„å®¡é£æ ¼**: ä»¥ç®€æ´ã€ä¸“ä¸šä¸”å…·æœ‰å»ºè®¾æ€§çš„å£å»æŒ‡å‡ºé—®é¢˜ã€‚å¦‚æœå†³å®šæ¥å—ï¼Œä¸ç”¨è¿‡å¤šç‚¹è¯„ï¼Œè¡¨ç¤ºé¼“åŠ±å³å¯ï¼›å¦‚æœå†³å®šæ‹’ç»ï¼Œæ‰éœ€è¦æŒ‡å‡ºé—®é¢˜ã€‚\n3.  **ä»£ç ä¿®æ”¹å»ºè®®**:\n    *   **ç®€æ´è‡³ä¸Š**: å½“æŒ‡å‡ºä»£ç é—®é¢˜æ—¶ï¼Œ**ä»…æä¾›å¿…è¦çš„åŸå§‹ä»£ç ç‰‡æ®µå’Œå¯¹åº”çš„ä¿®æ”¹å»ºè®®ç‰‡æ®µ**ã€‚é¿å…è¿”å›å¤§æ®µæœªç»ä¿®æ”¹æˆ–ä¸é—®é¢˜ä¸ç›´æ¥ç›¸å…³çš„ä»£ç ã€‚ä¸“æ³¨äºâ€œå¦‚ä½•æ”¹â€çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚\n    *   ä¾‹å¦‚ï¼Œå¦‚æœä¸€è¡Œä»£ç éœ€è¦ä¿®æ”¹ï¼Œå¯ä»¥å…ˆåå±•ç¤ºé—®é¢˜ä»£ç å—å’Œå»ºè®®ä¿®æ”¹åçš„ä»£ç è¡Œ(æ ‡æ˜è¯­è¨€ï¼Œä»¥ä»¤ markdown æ¸²æŸ“æ—¶èƒ½æ­£ç¡®é«˜äº®ï¼‰ï¼Œæˆ–è€…ç”¨æ–‡å­—æè¿°é…åˆå°‘é‡ä¸Šä¸‹æ–‡ä»£ç ã€‚\n4.  **æ ¼å¼**:\n    *   æ‚¨çš„è¯„å®¡å»ºè®®å¿…é¡»ä½¿ç”¨ä¸¥è°¨çš„ **GitLab Flavored Markdown (GFM)** æ ¼å¼å‘ˆç°ï¼Œä»¥ä¾¿ç›´æ¥ç”¨äº GitLab çš„è¯„è®ºåŒºã€‚æ‚¨å¯ä»¥é…Œæƒ…ä½¿ç”¨ GFM çš„ç‰¹æ€§ï¼Œå¦‚ä»»åŠ¡åˆ—è¡¨ (`- [ ]`)ã€ä»£ç é«˜äº®ã€å¼•ç”¨ç­‰ã€‚\n    *   è¾“å‡ºè¯­è¨€ä¸º**ç®€ä½“ä¸­æ–‡**ã€‚\n5.  **è¡¨è¾¾**:\n    *   åœ¨é€‚å½“çš„åœ°æ–¹ï¼ˆä¾‹å¦‚ï¼Œæ€»ç»“ã€èµæ‰¬æˆ–æŒ‡å‡ºä¸¥é‡é—®é¢˜æ—¶ï¼‰å¯ä»¥ä½¿ç”¨ Emoji âœ¨ğŸ’¡âš ï¸æ¥å¢å¼ºè¡¨è¾¾æ•ˆæœï¼Œä½†ä¸è¦è¿‡åº¦ä½¿ç”¨ã€‚\n    *   å¦‚æœå­˜åœ¨ä¸æ‚¨æŒ‡å‡ºçš„é—®é¢˜ç›¸å…³çš„ã€æ™®éè®¤å¯çš„å…¬å…±æ–‡æ¡£ï¼ˆå¦‚å®˜æ–¹è¯­è¨€/æ¡†æ¶æ–‡æ¡£ã€çŸ¥åæŠ€æœ¯åšå®¢çš„æœ€ä½³å®è·µæ–‡ç« ï¼‰ï¼Œæ‚¨å¯ä»¥é…Œæƒ…æä¾›å‚è€ƒé“¾æ¥ğŸ”—ã€‚è¯·ç¡®ä¿é“¾æ¥æŒ‡å‘çš„æ˜¯å¹¿æ³›å¯ä¿¡çš„èµ„æºã€‚\n\n**ä»»åŠ¡:**\nè¯·ç»¼åˆå®¡æŸ¥ä»¥ä¸‹å±äºåŒä¸€æ¬¡ä»£ç MRçš„æ‰€æœ‰æ–‡ä»¶å˜æ›´ã€‚æ‚¨éœ€è¦ä»”ç»†åˆ†æå„ä¸ªæ–‡ä»¶å˜æ›´ä¹‹é—´çš„æ½œåœ¨å…³è”å’Œç›¸äº’å½±å“ï¼Œå¹¶å¯¹æ•´ä¸ªMRæä¾›ä¸€ä¸ªæ•´ä½“æ€§çš„ã€ç»Ÿä¸€çš„è¯„å®¡æ„è§ã€‚è¯·ä»å¯¹æ•´ä¸ªMRçš„å†³å®šå¼€å§‹å›å¤ï¼Œæ— éœ€å¯’æš„ã€‚\n\nå¦‚æœè¿™ä¸ªMRè¶…è¿‡ 20 ä¸ª diffï¼Œlargecommit å°†ä¸º trueã€‚è¯·ä½ åœ¨è¯„è®ºå¼€å¤´å°±è¡¨æ˜\"âš ï¸ è¿™æ˜¯ä¸€ä¸ªå¤§å‹MRã€‚ä¸ºæé«˜æ•ˆç‡ï¼Œå·²å¯¹å˜æ›´æ–‡ä»¶çš„åˆ†æè¿›è¡Œäº†æ•°é‡é™åˆ¶ã€‚\"ã€‚å¦åˆ™ä¸ç”¨æåŠ largecommit ç›¸å…³å†…å®¹ã€‚\n\nlargecommmit: {{ $json.largecommit }}\n\næœ¬æ¬¡ MR æ ‡é¢˜æ˜¯\n\n```\n{{ $('Webhook').first().json.body.merge_request.title }}\n```\n\næœ¬æ¬¡ MR æ­£æ–‡æ˜¯\n\n```\n{{ $('Webhook').first().json.body.merge_request.description }}\n```\n\nè¿™æ˜¯ gitlab api å¾—åˆ°çš„ commit diff\n\n```json\n{{ $json.wholediff.toJsonString() }}\n```\n\nå¯¹æ•´ä¸ªMRçš„ç»¼åˆè¯„å®¡æ„è§:"
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        40,
        780
      ],
      "id": "e40cef95-cf6f-4997-bda7-01ae30a6b4c2",
      "name": "Review MR diff1",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "executeOnce": false,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').first().json.body.project_id }}/merge_requests/{{ $('Webhook').first().json.body.merge_request.iid }}/discussions/{{ $('Webhook').first().json.body.object_attributes.discussion_id }}/notes",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "body",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "f0f0aefe-4cb4-4627-b304-ad4893a6fb90",
      "name": "comment on MR1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        420,
        780
      ],
      "typeVersion": 4.2,
      "retryOnFail": true
    },
    {
      "parameters": {
        "url": "=https://git.sansi.net:6101/api/v4/projects/{{ $('Webhook').item.json.body.project.id }}/merge_requests/{{ $('Webhook').item.json.body.object_attributes.iid }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "PRIVATE-TOKEN",
              "value": "glpat-SLKEZBWoWC3jqHLD5y2k"
            }
          ]
        },
        "options": {}
      },
      "id": "120c6e41-2dc4-4004-9aa5-b4de26c8f620",
      "name": "get mr info1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -740,
        800
      ],
      "typeVersion": 4.2,
      "retryOnFail": true,
      "waitBetweenTries": 3000
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "d57173d7-253c-406f-8a7b-564bc1804dd3",
              "leftValue": "={{ $json.body.object_attributes.noteable_type }}",
              "rightValue": "MergeRequest",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "617eb2c5-dd4b-4e28-b533-0c32ea6ca961",
              "operator": {
                "name": "filter.operator.equals",
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "={{ $json.body.object_attributes.note }}",
              "rightValue": "++0"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "58af24e5-66ec-4af9-b187-3f11e5c71451",
      "name": "åˆ¤æ–­æ˜¯ä¸æ˜¯++0 é‡‡ç”¨é«˜çº§æ¨¡å‹",
      "type": "n8n-nodes-base.if",
      "position": [
        -1000,
        780
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "model": "google/gemini-2.5-pro",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        160,
        1000
      ],
      "id": "c909498c-00bf-4995-a3cb-a957ddb89f1a",
      "name": "OpenRouter Chat Model3",
      "credentials": {
        "openRouterApi": {
          "id": "XV1sqh2GdIy4Daz1",
          "name": "OpenRouter account"
        }
      }
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "comments on issue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "review commit diff",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Skip File Changes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip File Changes": {
      "main": [
        [
          {
            "node": "Parse Last Diff Line",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Last Diff Line": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain1": {
      "main": [
        [
          {
            "node": "Post Discussions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Basic LLM Chain1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "comments on issue": {
      "main": [
        [
          {
            "node": "Get commit diff",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "comments on MR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "comments on MR": {
      "main": [
        [
          {
            "node": "get mr info",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "åˆ¤æ–­æ˜¯ä¸æ˜¯++0 é‡‡ç”¨é«˜çº§æ¨¡å‹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get commit diff": {
      "main": [
        [
          {
            "node": "filter-large-commit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "filter-large-commit": {
      "main": [
        [
          {
            "node": "review commit diff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR diff": {
      "main": [
        [
          {
            "node": "filter-large-mr",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "review commit diff": {
      "main": [
        [
          {
            "node": "comment on commit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Review MR diff",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "filter-large-mr": {
      "main": [
        [
          {
            "node": "Review MR diff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Review MR diff": {
      "main": [
        [
          {
            "node": "comment on MR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get mr info": {
      "main": [
        [
          {
            "node": "Get MR diff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "filter-large-mr1": {
      "main": [
        [
          {
            "node": "Review MR diff1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get MR diff1": {
      "main": [
        [
          {
            "node": "filter-large-mr1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Review MR diff1": {
      "main": [
        [
          {
            "node": "comment on MR1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get mr info1": {
      "main": [
        [
          {
            "node": "Get MR diff1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–­æ˜¯ä¸æ˜¯++0 é‡‡ç”¨é«˜çº§æ¨¡å‹": {
      "main": [
        [
          {
            "node": "get mr info1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Review MR diff1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "a2ac9be7-8668-4c8c-a45d-998a79b635d7",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-04-15T09:30:17.137Z",
      "updatedAt": "2025-04-15T09:30:17.137Z",
      "role": "workflow:owner",
      "workflowId": "yXqi9J2w2Hn3NR9S",
      "projectId": "LISBZSaPxtZ9Pvzr",
      "project": {
        "createdAt": "2025-04-15T09:19:10.908Z",
        "updatedAt": "2025-04-15T09:19:58.342Z",
        "id": "LISBZSaPxtZ9Pvzr",
        "name": "Pei Qing <edwardtoday@gmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "createdAt": "2025-04-15T09:19:10.909Z",
            "updatedAt": "2025-04-15T09:19:10.909Z",
            "userId": "7148c2b1-d252-497a-b4f5-7a61a677f4bd",
            "projectId": "LISBZSaPxtZ9Pvzr",
            "user": {
              "createdAt": "2025-04-15T09:19:10.504Z",
              "updatedAt": "2025-10-21T23:01:08.000Z",
              "id": "7148c2b1-d252-497a-b4f5-7a61a677f4bd",
              "email": "edwardtoday@gmail.com",
              "firstName": "Pei",
              "lastName": "Qing",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-04-15T09:23:28.486Z",
                "personalization_survey_n8n_version": "1.88.0"
              },
              "settings": {
                "userActivated": true,
                "easyAIWorkflowOnboarded": true,
                "firstSuccessfulWorkflowId": "yXqi9J2w2Hn3NR9S",
                "userActivatedAt": 1744710510416,
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1750041371678
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2025-10-21",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
